<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<!-- üü¢ Mobile App Config -->
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="EGAT OT">

<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT (EGAT)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{ 
      /* Color Palette */
      --brand: #00306e;       /* EGAT Blue */
      --brand-dark: #002352;
      --brand-light: #ebf5ff;
      --accent: #f59e0b;      /* Amber */
      --accent-light: #fffbeb;
      --success: #10b981; 
      --danger: #ef4444; 
      --danger-soft: #fef2f2;
      
      /* UI Colors */
      --bg-body: #f8fafc;     
      --bg-card: #ffffff;
      --bg-input-zone: #f1f5f9; 
      --text-main: #334155;   
      --text-muted: #64748b;
      --border: #e2e8f0;
      
      --radius: 20px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
      
      /* Mobile SafeArea */
      --safe-bottom: env(safe-area-inset-bottom, 20px);
  }

  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg-body); font-family:'Sarabun',system-ui,-apple-system,Segoe UI; color:var(--text-main); -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
  
  /* Layout Structure */
  .app{ min-height:100vh; display:flex; overflow: hidden; /* Lock main scroll */ }

  /* =========================================
     üíª DESKTOP LAYOUT (LOCKED - DO NOT EDIT)
     ========================================= */
  .sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: width .2s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      box-shadow: var(--shadow-sm);
      height: 100vh; /* Full height */
      overflow-y: auto;
  }
  .sidebar.collapsed { width: 76px; }

  .content {
      flex: 1;
      height: 100vh;
      overflow-y: auto; /* Internal scroll */
      display: flex;
      flex-direction: column;
      background-color: var(--bg-body);
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
  }

  /* =========================================
     üì± MOBILE LAYOUT (FIXED & SPACIOUS)
     ========================================= */
  @media (max-width: 768px) {
      .app { 
          flex-direction: column; 
          height: 100vh; /* Strict viewport height */
          width: 100%;
      }
      
      /* Mobile Bottom Nav - Fixed & Clear */
      .sidebar {
          width: 100% !important; /* Force full width */
          height: 70px !important; /* Fixed height */
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          border-right: none;
          border-top: 1px solid rgba(0,0,0,0.1);
          flex-direction: row; 
          padding: 0;
          padding-bottom: var(--safe-bottom);
          justify-content: space-around; 
          align-items: center;
          background: #ffffff; /* Solid background to prevent see-through mess */
          box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
          z-index: 9999; /* Highest priority */
      }
      .sidebar.collapsed { width: 100% !important; } 
      
      /* Hide Desktop Elements */
      .brand, .collapse-btn { display: none !important; } 
      
      .menu { 
          flex-direction: row; 
          width: 100%; 
          justify-content: space-around; 
          margin: 0; 
          height: 100%;
          align-items: center;
      }
      
      .menu-item {
          flex-direction: column;
          gap: 4px;
          padding: 0;
          border-radius: 0;
          font-size: 0.7rem;
          flex: 1;
          height: 100%;
          justify-content: center;
          text-align: center;
          border: none;
          background: transparent !important; 
          box-shadow: none !important;
          color: #94a3b8;
      }
      .menu-item:hover { transform: none; }
      
      .menu-item.active { 
          color: var(--brand); 
          font-weight: 800;
      }
      
      .icon { width: 24px; height: 24px; font-size: 1.5rem; margin-bottom: 0; display:block; margin: 0 auto; }
      .label { font-size: 0.65rem; white-space: nowrap; line-height: 1; display:block; }
      .arrow-icon { display: none; } 
      .submenu { display: none !important; }
      .badge { position: absolute; top: 5px; right: 20%; font-size: 0.6rem; padding: 2px 5px; border: 1px solid #fff; z-index: 10; }

      /* Content Area - Mobile Scroll Fix */
      .content { 
          height: 100%; 
          width: 100%;
          overflow-y: scroll; /* Native scroll */
          -webkit-overflow-scrolling: touch;
          display: block; 
          padding-bottom: 120px !important; /* üü¢ HUGE PADDING to clear bottom bar */
      }
      
      .view.active { 
          padding: 15px 15px 150px 15px !important; /* Ensure content is pushed up */
          display: block; 
          min-height: auto; 
      }
      
      .card { 
          padding: 20px 16px; 
          margin-bottom: 30px; 
          border-radius: 20px;
          border-top-width: 6px;
      }

      /* Fix Input visibility on mobile keyboard */
      input, select, textarea {
          font-size: 16px !important; /* No zoom */
      }
      
      /* Mobile Form Layout */
      .grid { grid-template-columns: 1fr; gap: 16px; }
      .driver-filter-wrapper { width: 100%; margin-top: 8px; justify-content: space-between; }
      
      /* Header & History Mobile */
      .history-header-container { padding: 16px; }
      .left-group { flex-direction: column; align-items: flex-start; gap: 6px; }
      
      /* Summary Cards Mobile */
      .summary-grid { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
      .sum-card { min-height: 70px; padding: 10px 4px; }
      .sum-card .lbl { font-size: 0.6rem; }
      .sum-card .val { font-size: 1.3rem; }
      
      /* Table Scroll */
      .table-container { overflow-x: auto; }
      
      /* Calculator Mobile */
      .calc { width: 100%; padding: 16px; }
      .keys button { padding: 15px 0; font-size: 1.4rem; }
      
      /* Modal Mobile */
      .modal { padding: 0; align-items: center; justify-content: center; }
      .modal-content { 
          width: 90%; 
          max-height: 80vh; 
          border-radius: 24px;
          margin-bottom: 80px; /* Lift up from bottom bar */
      }
  }

  /* Desktop Styles (Keep Locked) */
  .brand{ display:flex; align-items:center; gap:12px; font-weight:800; color:var(--brand); padding:12px; border-radius:12px; background:linear-gradient(135deg, #fff, #f8fafc); border: 1px solid var(--border); justify-content:space-between; margin-bottom: 12px; }
  .brand .left{display:flex; align-items:center; gap:10px}
  .brand .dot{width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);}
  .brand .txt { font-size: 1.1rem; letter-spacing: -0.5px; }
  .collapse-btn{ all:unset; cursor:pointer; padding:6px; border-radius:8px; color:var(--text-muted); display: grid; place-items: center; transition: all 0.2s; }
  .collapse-btn:hover{ background:var(--bg-body); color:var(--brand); }
  .menu-item { display:flex; gap:12px; align-items:center; text-decoration:none; color:var(--text-muted); padding:14px 16px; border-radius:12px; cursor: pointer; transition: all 0.2s; font-weight: 500; position: relative; }
  @media (min-width: 769px) {
      .menu-item:hover { background:var(--bg-body); color: var(--brand); transform: translateX(2px); }
      .menu-item.active { background:var(--brand-light); color:var(--brand); font-weight:700; box-shadow: inset 3px 0 0 var(--brand); }
  }
  
  /* Submenu */
  .submenu { display: none; flex-direction: column; gap: 4px; padding-left: 20px; margin-top: -4px; margin-bottom: 8px; }
  .submenu.open { display: flex; animation: slideDown 0.2s ease-out; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  .submenu-item { display: flex; gap: 10px; align-items: center; padding: 10px 16px; border-radius: 12px; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
  .submenu-item:hover { background: var(--bg-body); color: var(--brand); }
  .submenu-item.active { background: #f1f5f9; color: var(--brand); font-weight: 700; box-shadow: inset 2px 0 0 var(--accent); }
    
  .badge { background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 99px; font-weight: 700; display: none; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3); }
  .sidebar.collapsed .label, .sidebar.collapsed .badge, .sidebar.collapsed .arrow-icon { display:none }
  .sidebar.collapsed .brand .left span.txt{ display:none }
  .sidebar.collapsed .submenu { display: none !important; }

  /* Input Zone */
  .input-zone { background-color: var(--bg-input-zone); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }

  label { font-weight: 700; color: var(--text-main); font-size: 0.95rem; margin-bottom: 6px; display: block; opacity: 0.9; }
   
  input, select, button, textarea { font-family: inherit; font-size: 1rem; }
  input[type="date"], input[type="text"], input[type="tel"], input[type="number"], select, input[type="month"] { 
    width: 100%; padding: 12px 14px; 
    border: 1px solid #cbd5e1; border-radius: 12px; background: #fff; color: var(--text-main); transition: all 0.2s; font-weight: 500; -webkit-appearance: none;
  }
  input:focus, select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0, 48, 110, 0.1); }
    
  .custom-date-input { position: relative; width: 100%; background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; display: flex; align-items: center; padding: 0; overflow: hidden; height: 48px; transition: all 0.2s; }
  .custom-date-input:focus-within { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0, 48, 110, 0.1); }
  .real-date-input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; padding: 0; }
  .fake-date-display { flex: 1; padding: 0 16px; font-size: 16px; font-weight: 500; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
  .icon-cal { padding-right: 16px; color: var(--text-muted); font-size: 1.2rem; pointer-events: none; }

  /* Time Inputs */
  input.time-manual { border: 1px solid #cbd5e1; background-color: #fff; color: var(--brand); font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; text-align: center; padding: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); border-radius: 12px; }
  input.time-manual:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0, 48, 110, 0.1); }

  /* Radio Line */
  .radio-line { display: flex; width: 100%; margin-top: 0; background: #e2e8f0; border-radius: 12px; padding: 4px; gap: 4px; }
  .radio-line label { flex: 1; margin: 0; padding: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 10px; transition: all 0.2s; font-weight: 600; color: var(--text-muted); font-size: 0.95rem; }
  .radio-line label:hover { background: rgba(255,255,255,0.8); color: var(--brand); }
  .radio-line label.active { background: #fff; color: var(--brand); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .radio-line input { display: none; }

  /* Actions */
  .actions { margin-top: 20px; }
   
  .primary { background: linear-gradient(135deg, var(--brand), #004e9a); color: #fff; border: none; padding: 16px; border-radius: 16px; cursor: pointer; font-weight: 700; width: 100%; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(0, 47, 108, 0.2); transition: all 0.2s; }
  .primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 47, 108, 0.25); }
  .primary:active { transform: scale(0.98); }
    
  .btn-secondary { background: #f1f5f9; color: var(--text-muted); border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 700; width: auto; font-size: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); transition: all 0.1s; }
  .btn-secondary:hover { background: #e2e8f0; color: var(--text-main); }

  /* Result Area */
  #result{ margin-top:20px; animation: slideUp 0.3s ease-out; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .result-wrap { border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); background: #fff; }
  .result-head { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: #fff; border-bottom: 1px solid var(--border); }
  .result-head .tt { font-weight: 800; color: var(--brand); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
  .result-head .tt::before { content: ''; width: 4px; height: 18px; background: var(--accent); border-radius: 4px; display: block; }
  .meta-pill { display: flex; align-items: center; gap: 8px; }
  .m-date, .m-time { color: var(--text-muted); background: #f8fafc; padding: 4px 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; border: 1px solid var(--border); }
  .result-section{ padding:18px; border-bottom: 1px solid var(--border); }
  .result-section:last-child { border-bottom: none; background: #f9fafb; }
  .result-title{ font-weight:700; color:var(--text-main); display:flex; align-items:center; gap:8px; margin-bottom:10px; font-size: 0.95rem; }
   
  .row{ display:grid; grid-template-columns:130px 70px 1fr; gap:10px; align-items:center; padding:10px; border-radius:12px; border:1px solid var(--border); background: #fff; margin-bottom: 6px; transition: transform 0.1s; font-size: 0.95rem; }
  .row:hover { border-color: var(--brand-light); transform: translateX(4px); }
  @media (max-width:560px){ .row{ grid-template-columns:1fr 60px 1fr; } }
   
  .time{ font-variant-numeric:tabular-nums; font-weight: 500; color: var(--text-main); }
  .rate{ justify-self:center; font-weight:800; padding:3px 8px; border-radius:8px; font-size:.8rem; letter-spacing: 0.5px; }
  .rate.x1{ background:#ecfeff; color:#0e7490; }
  .rate.x15{ background:var(--brand-light); color:var(--brand); }
  .rate.x3{ background:#fff1f2; color:#be123c; }
  .dur{ text-align:right; font-variant-numeric:tabular-nums; font-weight: 600; }
  .breaks{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
  .break-chip{ background:#f1f5f9; color:var(--text-muted); border:1px solid var(--border); border-radius:20px; padding:3px 10px; font-size:.8rem; }
   
  .total-box{ display:grid; gap:6px; }
  .total-line{ display:flex; justify-content:space-between; font-weight:600; color: var(--text-muted); font-size: 0.95rem; }
  .total-line .v { font-weight: 800; color: var(--text-main); }
  .total-line.em{ border-top:1px dashed var(--border); padding-top:10px; margin-top: 6px; color:var(--brand); font-size: 1.05rem; }

  /* Save Buttons */
  .btn-group { display: flex; gap: 10px; width: 100%; margin-top: 18px; }
  .btn-save { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 14px; border-radius: 14px; cursor: pointer; font-weight: 700; flex: 2; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); font-size: 1rem; }
  .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 10px -2px rgba(16, 185, 129, 0.4); }
  .btn-save:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-next { background: #fff; color: var(--text-muted); border: 2px solid var(--border); padding: 14px; border-radius: 14px; cursor: pointer; font-weight: 700; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-size: 1rem; }
  .btn-next:hover { background: #f8fafc; color: var(--text-main); border-color: var(--text-muted); }

  /* History Header */
  .history-header-container { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; background: linear-gradient(to right, #e2e8f0, #f8fafc); padding: 16px 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #cbd5e1; gap: 12px; box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.05); }
  .left-group { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px; margin-bottom: 4px; width: 100%; }
  .right-group { margin-left: 0; width: 100%; display: flex; justify-content: flex-start; }
  .history-title { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--brand); letter-spacing: -0.5px; cursor: default; }
  
  .month-picker-inline { position: relative; display: inline-flex; align-items: center; border-bottom: 2px dashed rgba(0,47,108,0.2); cursor: pointer; padding-bottom: 2px; transition: all 0.2s; }
  .month-picker-inline:hover { border-bottom-color: var(--accent); }
  .month-text { font-size: 1.4rem; font-weight: 700; color: var(--text-muted); }
  .month-text:hover { color: var(--brand); }
  .history-date-input-hidden { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; display:none; }

  /* Driver Filter */
  .driver-filter-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 10px; background: #fff; border: 1px solid #cbd5e1; padding: 10px 16px; border-radius: 12px; box-shadow: var(--shadow-sm); transition: all 0.2s; width: 100%; }
  .driver-filter-wrapper:hover { box-shadow: var(--shadow); border-color: var(--brand-light); }
  .filter-label { margin: 0; font-weight: 700; color: var(--text-muted); font-size: 0.95rem; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
  .filter-select { border: none; background: transparent; padding: 4px 8px; font-weight: 700; font-size: 1rem; color: var(--brand); outline: none; cursor: pointer; min-width: 140px; }
  .filter-select:hover { color: var(--brand-dark); }
  
  /* Mobile View Switcher */
  .mobile-view-switcher { display: flex; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 4px; margin-bottom: 12px; }
  .mvs-btn { flex: 1; border: none; background: transparent; padding: 10px; font-size: 1rem; font-weight: 600; color: var(--text-muted); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
  .mvs-btn.active { background: var(--brand-light); color: var(--brand); font-weight: 800; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  @media (min-width: 769px) { .mobile-view-switcher { display: none; } }

  /* Toolbar */
  .history-toolbar-container { margin-top: 15px; margin-bottom: 20px; padding: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 18px; display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 8px; align-items: stretch; justify-content: space-between; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); -ms-overflow-style: none; scrollbar-width: none; }
  .history-toolbar-container::-webkit-scrollbar { display: none; }
  
  .tool-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 6px; border-radius: 12px; border: 1px solid transparent; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); color: var(--text-muted); white-space: nowrap; min-width: fit-content; }
  .tool-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  .tool-btn:active { transform: scale(0.98); }
  .tool-btn.t-create { color: #0284c7; background: linear-gradient(to bottom, #fff, #f0f9ff); border-color: #bae6fd; }
  .tool-btn.t-create:hover { background: #e0f2fe; }
  .tool-btn.t-warn { color: #d97706; background: linear-gradient(to bottom, #fff, #fffbeb); border-color: #fcd34d; }
  .tool-btn.t-warn:hover { background: #fef3c7; }
  .tool-btn.t-danger { color: #e11d48; background: linear-gradient(to bottom, #fff, #fff1f2); border-color: #fecdd3; }
  .tool-btn.t-danger:hover { background: #ffe4e6; }
  .tool-btn.t-view { color: #475569; background: linear-gradient(to bottom, #fff, #f8fafc); border-color: #cbd5e1; }
  .tool-btn.t-view:hover { background: #f1f5f9; }
  .tool-divider { display:none; }

  /* Summary Cards */
  .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
  .sum-card { padding: 16px; border-radius: 16px; color: white; text-align: center; box-shadow: var(--shadow-lg); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; min-height: 100px; transition: transform 0.2s; }
  .sum-card:hover { transform: translateY(-3px); }
  .sum-card.c-15 { background: linear-gradient(135deg, #2563eb, #1e40af); } 
  .sum-card.c-1 { background: linear-gradient(135deg, #06b6d4, #0e7490); }
  .sum-card.c-3 { background: linear-gradient(135deg, #e11d48, #be123c); } 
  .sum-card::after { content: ''; position: absolute; top: -15px; right: -15px; width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.15); pointer-events: none; }
  .sum-card .lbl { font-size: 0.85rem; font-weight: 600; opacity: 0.9; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
  .sum-card .val { font-size: 2rem; font-weight: 800; line-height: 1; margin: 2px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .sum-card .unit { font-size: 0.75rem; opacity: 0.8; font-weight: 500; }

  /* Total Summary */
  .total-summary-section { background: #fff; border: 1px solid var(--border); border-radius: 16px; margin-top: 20px; display: flex; overflow: hidden; box-shadow: var(--shadow); padding: 0; }
  .summary-half { flex: 1; padding: 16px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
  .summary-half:first-child { border-right: 1px dashed var(--border); background: linear-gradient(to bottom right, #fff7ed, #fff); }
  .summary-half:last-child { background: linear-gradient(to bottom right, #f0f9ff, #fff); }
  .summary-half .lbl { font-size: 0.95rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
  .summary-half .val-group { display: flex; align-items: baseline; gap: 6px; }
  .summary-half .val { font-size: 2rem; font-weight: 800; line-height: 1; }
  .summary-half .unit { font-size: 0.85rem; font-weight: 600; opacity: 0.7; }
  .summary-half.leave .val { color: var(--accent); }
  .summary-half.ot .val { color: var(--brand); }

  /* Table */
  .table-container { border-radius: 16px; box-shadow: var(--shadow); background: #fff; border: 1px solid var(--border); margin-top: 20px; overflow-x: auto; }
  .history-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 100%; font-size: 0.85rem; }
  .history-table thead th { background: #f8fafc; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem; font-weight: 800; padding: 10px 8px; border-bottom: 2px solid var(--border); white-space: nowrap; }
  .history-table td { padding: 8px 8px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); vertical-align: middle; white-space: nowrap; }
  .history-table tr:last-child td { border-bottom: none; }
  .history-table tbody tr:hover { background: #fdfeff; }
  .col-center { text-align: center; }
  .col-right { text-align: right; }
  
  /* Row Actions & Pills */
  .row-actions { display: flex; align-items: center; justify-content: center; gap: 4px; }
  .action-btn-sm { border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; transition: all 0.2s; }
  .action-btn-sm:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .btn-view-sm { background: #e0f2fe; color: #0284c7; }
  .btn-reset-sm { background: #fffbeb; color: #d97706; }
  
  .pill { display: inline-block; padding: 4px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; cursor: pointer; transition: all 0.2s; user-select: none; border: 1px solid transparent; }
  .pill:hover { transform: scale(1.05); }
  .pill-weekday { background: #f0f9ff; color: #0369a1; border-color: #bae6fd; }
  .pill-weekend { background: #fff1f2; color: #be123c; border-color: #fecdd3; }
    
  .time-range { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--text-main); background: #f8fafc; padding: 4px 8px; border-radius: 8px; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; border: 1px solid var(--border); transition: all 0.2s; }
  .time-range:hover { background: #fff; border-color: var(--brand); color: var(--brand); box-shadow: var(--shadow-sm); }
  .time-range.pending { background: #fff; border: 1px dashed #cbd5e1; color: #94a3b8; }
  .time-range.pending:hover { background: #f0f9ff; border-color: #3b82f6; color: #3b82f6; }

  /* Inline Edit */
  .edit-row-wrap { display: flex; align-items: center; justify-content: center; gap: 4px; }
  .mini-input { padding: 4px 6px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-family: inherit; font-weight: 600; color: var(--brand); font-size: 0.85rem; background: #fff; outline: none; box-shadow: var(--shadow-sm); width: 60px; }
  .mini-input:focus { border-color: var(--brand); box-shadow: 0 0 0 2px var(--brand-light); }
  .mini-btn { width: 26px; height: 26px; border: none; border-radius: 50%; display: grid; place-items: center; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); color: white; font-size: 0.8rem; }
  .mini-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .mini-btn.ok { background: var(--success); } 
  .mini-btn.cancel { background: var(--danger); } 

  /* OT Badges */
  .ot-val { cursor: pointer; font-weight: 800; padding: 2px 8px; border-radius: 6px; transition: all 0.2s; font-size: 0.85rem; display: inline-block; min-width: 36px; text-align: center; }
  .ot-val:hover { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transform: scale(1.1); }
  .val-15 { color: #1e3a8a; background: #eff6ff; border: 1px solid #bfdbfe; }
  .val-1  { color: #0e7490; background: #ecfeff; border: 1px solid #a5f3fc; }
  .val-3  { color: #be123c; background: #fff1f2; border: 1px solid #fecdd3; }

  /* Drivers List */
  .driver-list-container { display: flex; flex-direction: column; gap: 8px; }
  .driver-item-row { display: grid; grid-template-columns: 50px 1fr auto; align-items: center; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; transition: all 0.2s; }
  .driver-item-row:hover { border-color: var(--brand-light); transform: translateX(4px); box-shadow: var(--shadow-sm); }
  .d-index { font-weight: 800; color: #cbd5e1; font-size: 1.2rem; text-align: center; }
  .d-info { display: flex; flex-direction: column; gap: 4px; }
  .d-main { font-weight: 700; color: var(--text-main); font-size: 1rem; }
  .d-sub { font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 10px; }
  .d-actions { display: flex; gap: 8px; }

  /* Calculator */
  .calc { width: min(520px, 100%); margin: 14px auto 0; background: #fff; border: 1px solid var(--border); border-radius: 24px; padding: 24px; box-shadow: var(--shadow); }
  .calc-display { width: 100%; height: 90px; border: none; border-radius: 16px; padding: 20px; font-size: 3.5rem; text-align: right; background: #f8fafc; color: var(--brand); font-weight: 700; margin-bottom: 24px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); }
  .keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .keys button { padding: 20px 0; border: 1px solid var(--border); background: #fff; border-radius: 16px; cursor: pointer; font-weight: 700; font-size: 1.3rem; color: var(--text-main); transition: all 0.1s; box-shadow: 0 4px 0 var(--border); margin-bottom: 4px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; }
  .keys button:active { transform: translateY(4px); box-shadow: none; margin-bottom: 0; margin-top: 4px; }
  .keys button.op { background: #f0f9ff; color: var(--brand); border-color: #bae6fd; box-shadow: 0 4px 0 #bae6fd; }
  .keys button.eq { background: var(--brand); color: #fff; border-color: var(--brand-dark); box-shadow: 0 4px 0 var(--brand-dark); }
  .keys button[data-k="0"] { grid-column: span 2; aspect-ratio: auto; }

  /* üü¢ CUSTOM MONTH PICKER STYLES */
  .cmp-content { text-align: center; padding: 10px; }
  .cmp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.4rem; font-weight: 800; color: var(--brand); }
  .cmp-nav-btn { background: #f0f9ff; border: none; width: 44px; height: 44px; border-radius: 12px; color: var(--brand); cursor: pointer; font-size: 1.2rem; font-weight: 700; transition: all 0.2s; display:grid; place-items:center; }
  .cmp-nav-btn:hover { background: var(--brand); color: white; }
  .cmp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .cmp-month-btn { padding: 16px 0; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; font-size: 1.1rem; font-weight: 600; color: var(--text-main); cursor: pointer; transition: all 0.2s; }
  .cmp-month-btn:hover { border-color: var(--brand); color: var(--brand); background: #f0f9ff; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .cmp-month-btn.active { background: var(--brand); color: white; border-color: var(--brand); box-shadow: 0 4px 8px rgba(0, 48, 110, 0.3); }

  /* Modal */
  .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal.show { display: flex; animation: fadeIn 0.2s; }
  .modal-content { background-color: #fefefe; padding: 24px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); position: relative; }
  .close-modal { position: absolute; top: 15px; right: 20px; color: #94a3b8; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; z-index: 10; }
  
  .view{display:none; animation: fadeIn 0.3s;}
  /* Active View Desktop Default */
  .view.active { display: flex; justify-content: center; align-items: flex-start; flex-grow: 1; padding: 20px 20px; min-height: 100%; box-sizing: border-box; }
  
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
   
  #emptyMsg { text-align:center; padding:60px 20px; color:var(--text-muted); display:none; }
  #emptyMsg div { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="left"><span class="dot"></span><span class="txt">EGAT Tools</span></div>
      <button class="collapse-btn" id="btnToggle" title="‡∏û‡∏±‡∏ö/‡∏Å‡∏≤‡∏á ‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á">‚â°</button>
    </div>
    <nav class="menu" id="menu">
      <div class="menu-item active" onclick="switchView('ot')">
        <span class="icon">‚è±Ô∏è</span><span class="label">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT</span>
      </div>
      <!-- üü¢ UPDATED: Sidebar Menu with Submenu -->
      <div class="menu-item-group" style="position:relative;">
          <div class="menu-item" onclick="toggleSidebarSubmenu('history-submenu')">
            <span class="icon">üìä</span><span class="label">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
            <span class="arrow-icon" style="margin-left:auto; font-size:0.7em; transition:0.2s;">‚ñº</span>
            <span class="badge" id="historyCount">0</span>
          </div>
          <div id="history-submenu" class="submenu">
             <div class="submenu-item" onclick="switchView('history'); setHistoryMode('daily')">1. ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏Å‡∏ï‡∏¥)</div>
             <div class="submenu-item" onclick="switchView('history'); setHistoryMode('driver')">2. ‡∏™‡∏£‡∏∏‡∏õ ‡∏û‡∏Ç‡∏£. (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)</div>
          </div>
      </div>

      <div class="menu-item" onclick="switchView('drivers')">
        <span class="icon">üë•</span><span class="label">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£.</span>
      </div>
      <div class="menu-item" onclick="switchView('calc')">
        <span class="icon">üßÆ</span><span class="label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</span>
      </div>
    </nav>
  </aside>

  <main class="content">
    <!-- OT -->
    <section id="view-ot" class="view active">
      <div class="card">
        <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ OT</h2>
          
        <!-- Input Zone Wrapper -->
        <div class="input-zone">
            <div class="grid">
                
              <!-- Driver Selection -->
              <div style="grid-column: 1 / -1;">
                <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ (‡∏û‡∏Ç‡∏£.)</label>
                <select id="driverSelect" style="width:100%; padding:12px;">
                    <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                </select>
              </div>

              <!-- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) -->
              <div>
                <!-- Changed Label ID to update dynamically -->
                <label id="dateLabel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                  
                <!-- Re-introduced Custom Wrapper for DD/MM/YYYY overlay -->
                <div class="custom-date-input">
                    <input type="date" id="workDate" class="real-date-input" lang="th-TH" onclick="try{this.showPicker()}catch(e){}">
                    <div id="workDateShow" class="fake-date-display">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</div>
                    <span class="icon-cal">üìÖ</span>
                </div>
              </div>

              <!-- 2. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô (‡∏Ç‡∏ß‡∏≤) -->
              <div>
                 <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô</label>
                 <div class="radio-line">
                  <label>
                      <input type="radio" name="type" value="weekday" checked> 
                      ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏®‡∏∏‡∏Å‡∏£‡πå
                  </label>
                  <label>
                      <input type="radio" name="type" value="weekend"> 
                      ‡πÄ‡∏™‡∏≤‡∏£‡πå‚Äì‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
                  </label>
                 </div>
              </div>
                
              <!-- Replaced Thai Date Text with Auto Fill Button -->
              <div style="grid-column: 1 / -1; margin-top: 15px;">
                  <!-- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å (padding:22px, font-size:1.35rem) -->
                  <button onclick="autoFillMonth()" class="action-btn" style="width:100%; padding:18px; background:#e0f2fe; border:2px solid #bae6fd; color:#0284c7; font-weight:800; font-size:1.2rem; border-radius:16px; display:flex; align-items:center; justify-content:center; gap:12px; box-shadow: 0 6px 12px -4px rgba(186, 230, 253, 0.6); transition: transform 0.1s;">
                    üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                  </button>
              </div>

              <!-- 3. ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á -->
              <div>
                <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 0730)</label>
                <input type="tel" id="startTime" class="time-manual" placeholder="07:30" maxlength="5">
              </div>
              <div>
                <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 1700)</label>
                <input type="tel" id="endTime" class="time-manual" placeholder="17:00" maxlength="5">
              </div>

            </div>
        </div>
        <!-- End Input Zone -->

        <div class="actions">
          <button class="primary" id="btnCalc">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì OT</button>
          <!-- ‡∏õ‡∏∏‡πà‡∏° Reset Form ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á -->
        </div>
        <div id="result"></div>
           
        <div id="saveSection" class="btn-group" style="display:none;">
            <button class="btn-save" id="btnSaveLog">üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="btn-next" onclick="resetFormForNext()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="view-history" class="view">
      <div class="card">
        <!-- üü¢ NEW UNIFIED HEADER BAR -->
        <div class="history-header-container">
            <!-- üü¢ MOBILE VIEW SWITCHER -->
            <div class="mobile-view-switcher">
                <button class="mvs-btn active" id="mvsDaily" onclick="setHistoryMode('daily')">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
                <button class="mvs-btn" id="mvsDriver" onclick="setHistoryMode('driver')">‡∏™‡∏£‡∏∏‡∏õ ‡∏û‡∏Ç‡∏£.</button>
            </div>
            
            <!-- Left: Title + Date -->
            <div class="left-group">
                <!-- üü¢ FIX: Title Static -->
                <h2 id="historyTitleBtn" class="history-title">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <!-- üü¢ CUSTOM TRIGGER -->
                <div class="month-picker-inline" onclick="openCustomMonthPicker('historyMonthPicker', 'historyDateDisplay')">
                    <span id="historyDateDisplay" class="month-text">...</span>
                    <span style="font-size:0.8em; margin-left:4px; opacity:0.5;">‚ñº</span>
                </div>
                <!-- Hidden Real Input -->
                <input type="text" id="historyMonthPicker" class="history-date-input-hidden" onchange="renderHistory()">
            </div>

            <!-- Right: Driver Filter Dropdown -->
            <div class="right-group">
                <div class="driver-filter-wrapper">
                    <label class="filter-label">üëÄ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á:</label>
                    <select id="historyDriverFilter" class="filter-select" onchange="handleFilterChange()">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- üü¢ RESTORED: Toolbar Buttons -->
        <div class="history-toolbar-container" id="historyToolbar">
             <button onclick="openCreateOptionModal()" class="tool-btn t-create" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
             <button onclick="openIncompleteModal()" class="tool-btn" style="background:#f3e8ff; border-color:#d8b4fe; color:#7e22ce;" title="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö">‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏î</button>
             
             <div class="tool-divider"></div>
             
             <button onclick="openFollowUpSummary()" class="tool-btn" style="background:#fff7ed; border-color:#fed7aa; color:#ea580c;" title="‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°</button>
             <button onclick="showAllHistory()" class="tool-btn t-view" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üëÅÔ∏è ‡∏î‡∏π‡∏´‡∏°‡∏î</button>
             
             <div class="tool-divider"></div>
             
             <button onclick="resetCurrentMonth()" class="tool-btn t-warn" title="‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
             <button onclick="openDeleteModal()" class="tool-btn t-danger" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö">üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
           
        <!-- Summary Grid (Sub) -->
        <div class="summary-grid">
            <div class="sum-card c-15">
                <div>
                    <div class="lbl">OT x1.5</div>
                    <div class="unit">(‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)</div>
                </div>
                <div class="val" id="sum15">0.0</div>
            </div>
            <div class="sum-card c-1">
                <div>
                    <div class="lbl">OT x1</div>
                    <div class="unit">(‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</div>
                </div>
                <div class="val" id="sum1">0.0</div>
            </div>
            <div class="sum-card c-3">
                <div>
                    <div class="lbl">OT x3</div>
                    <div class="unit">(‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</div>
                </div>
                <div class="val" id="sum3">0.0</div>
            </div>
        </div>

        <!-- üü¢ New Total Summary (Split) -->
        <div class="total-summary-section">
            <div class="summary-half leave">
                <div class="lbl">‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏•‡∏≤</div>
                <div class="val-group">
                    <span class="val" id="sumLeaveDays">0</span>
                    <span class="unit">‡∏ß‡∏±‡∏ô</span>
                </div>
            </div>
            <div class="summary-half ot">
                <div class="lbl">‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT</div>
                <div class="val-group">
                    <span class="val" id="sumTotal_b">0.0</span>
                    <span class="unit">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <!-- üü¢ NEW CHECKBOX COLUMN -->
                        <th width="5%" class="col-center">‡∏•‡∏≤</th>
                        <!-- üü¢ Compact Column Widths -->
                        <th width="12%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th width="10%" class="col-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th width="20%" class="col-center">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <!-- üü¢ Split OT Columns (Distinct Colors) -->
                        <th width="10%" class="col-center" style="background:#eff6ff; color:#1e3a8a; border-bottom-color:#bfdbfe;">x1.5</th>
                        <th width="10%" class="col-center" style="background:#ecfeff; color:#0e7490; border-bottom-color:#a5f3fc;">x1</th>
                        <th width="10%" class="col-center" style="background:#fff1f2; color:#be123c; border-bottom-color:#fecdd3;">x3</th>
                         
                        <th width="10%" class="col-center">‡∏£‡∏ß‡∏°</th>
                        <th width="18%" class="col-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                    </tr>
                </thead>
                <tbody id="historyList"></tbody>
            </table>
            <div id="emptyMsg" style="text-align:center; padding:40px; color:#94a3b8; display:none;">
                <div style="font-size:3rem; margin-bottom:10px;">üì≠</div>
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </div>
        </div>
           
      </div>
    </section>

    <!-- Drivers Management View (Updated Layout: List Rows) -->
    <section id="view-drivers" class="view">
      <div class="card">
        <!-- üü¢ Flex Header: Title + Button inline -->
        <div class="driver-header-flex" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <button onclick="openAddDriverModal()" class="primary" style="width:auto; padding: 10px 20px; font-size:1rem; display:flex; align-items:center; gap:6px;">
                <span>‚ûï</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>
        
        <div id="driverListContainer" class="driver-list-container">
            <!-- JS renders here -->
        </div>
      </div>
    </section>

    <!-- Calculator -->
    <section id="view-calc" class="view">
      <div class="card">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</h2>
        <div class="calc">
          <input id="calcDisplay" class="calc-display" type="text" readonly value="0">
          <div class="keys">
            <button class="op" data-k="C" style="color:var(--danger)">‡∏•‡πâ‡∏≤‡∏á</button>
            <button class="op" data-k="BS" style="color:var(--brand)">‡∏•‡∏ö</button>
            <button class="op" data-k="%">%</button><button class="op" data-k="/">√∑</button>
            <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button class="op" data-k="*">√ó</button>
            <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button class="op" data-k="-">‚àí</button>
            <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button class="op" data-k="+">+</button>
            <button data-k="0" style="grid-column:span 2">0</button><button data-k=".">.</button><button class="eq" data-k="=">=</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div id="modalBody"></div>
    </div>
  </div>

  <!-- üü¢ Create Option Modal -->
  <div id="createOptionModal" class="modal">
      <div class="modal-content" style="text-align:center;">
          <span class="close-modal" onclick="closeCreateOptionModal()">&times;</span>
          <h2 style="color:var(--brand); margin-bottom:20px;">üìÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£?</h2>
          <!-- üü¢ Added Month Picker for Create -->
          <div style="margin-bottom:15px; text-align:left; position:relative;">
              <label style="font-weight:700; color:var(--text-muted);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á:</label>
              <!-- Mask Input -->
              <div style="position:relative; margin-top:5px; height:44px; border:1px solid #cbd5e1; border-radius:12px; background:#fff; display:flex; align-items:center; overflow:hidden; cursor:pointer;" onclick="openCustomMonthPicker('createTargetMonth', 'createMonthDisplay')">
                  <div id="createMonthDisplay" style="padding:0 14px; width:100%; font-weight:700; color:var(--brand); pointer-events:none;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...</div>
                  <input type="text" id="createTargetMonth" style="display:none;">
              </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:12px;">
              <button onclick="initiateAutoFill('single')" class="primary" style="background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd;">üë§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ 1 ‡∏Ñ‡∏ô (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</button>
              <button onclick="initiateAutoFill('all')" class="primary" style="background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0;">üë• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ)</button>
          </div>
          <button onclick="closeCreateOptionModal()" class="btn-next" style="margin-top:20px; width:100%;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
  </div>

  <!-- üü¢ CUSTOM MONTH PICKER MODAL -->
  <div id="customMonthPickerModal" class="modal">
      <div class="modal-content" style="text-align:center; max-width:320px;">
          <span class="close-modal" onclick="closeCustomMonthPicker()">&times;</span>
          <div class="cmp-content">
              <div class="cmp-header">
                  <button class="cmp-nav-btn" onclick="adjustPickerYear(-1)">‚ùÆ</button>
                  <span id="cmpYearDisplay">2568</span>
                  <button class="cmp-nav-btn" onclick="adjustPickerYear(1)">‚ùØ</button>
              </div>
              <div class="cmp-grid" id="cmpMonthGrid">
                  <!-- Months injected by JS -->
              </div>
          </div>
          <button onclick="closeCustomMonthPicker()" class="btn-next" style="margin-top:20px; width:100%;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
  </div>

  <!-- Add Driver Modal (Hidden by default) -->
  <div id="addDriverModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddDriverModal()">&times;</span>
        <!-- Added hidden field for ID -->
        <input type="hidden" id="editDriverId">
        <h2 id="driverModalTitle" style="font-size:1.5rem; margin-bottom:20px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£. ‡πÉ‡∏´‡∏°‡πà</h2>
        <div class="driver-form-grid">
            <div style="grid-column:span 2;">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span style="color:var(--danger)">*</span></label>
                <input type="text" id="dName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
            </div>
            <div>
                <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                <input type="text" id="dNick" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≤‡∏¢">
            </div>
            <div>
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input type="tel" id="dPhone" placeholder="08x-xxx-xxxx">
            </div>
            <div>
                <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                <input type="text" id="dAff" placeholder="‡πÄ‡∏ä‡πà‡∏ô EGAT">
            </div>
            <div>
                <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
                <input type="text" id="dDept" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞">
            </div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
             <!-- Changed function to unified saveDriver -->
             <button onclick="saveDriver()" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
             <button onclick="closeAddDriverModal()" class="btn-next" style="background:#f1f5f9; color:var(--text-main);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <!-- üü¢ Incomplete Modal (Updated with Grid) -->
  <div id="incompleteModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeIncompleteModal()">&times;</span>
        <h2 style="font-size:1.5rem; margin-bottom:20px; color:#7e22ce;">üì© ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</h2>
        <div class="driver-form-grid" style="grid-template-columns: 1fr;">
             <div>
                <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏û‡∏Ç‡∏£.)</label>
                <select id="incDriverSelect" style="width:100%; padding:12px; background:#f8fafc;"></select>
            </div>
            <!-- Added Month and Grid Input -->
            <div>
                <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label>
                <input type="month" id="incMonth" style="width:100%;" onchange="renderIncDays()">
            </div>
            <div>
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î (‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</label>
                <!-- Grid Container -->
                <div id="incDaysGrid" class="day-grid"></div>
            </div>
            <div>
                <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î (‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</label>
                <div class="quick-notes-wrapper">
                    <div class="quick-notes-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô:</div>
                    <div class="quick-notes">
                        <div class="note-chip" onclick="addIncNoteText('‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö OT')">üìÑ ‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö OT</div>
                        <div class="note-chip" onclick="addIncNoteText('‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡∏•‡∏≤')">üèñÔ∏è ‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡∏•‡∏≤</div>
                        <div class="note-chip" onclick="addIncNoteText('‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ß‡∏•‡∏≤')">‚è∞ ‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
                    </div>
                </div>
                <textarea id="incNote" rows="3" style="width:100%; padding:10px; border-radius:12px; border:1px solid #cbd5e1; font-family:inherit;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö OT, ‡∏•‡∏∑‡∏°‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡∏•‡∏≤..."></textarea>
            </div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
             <button onclick="saveIncompleteReport()" class="primary" style="background:#9333ea; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
             <button onclick="closeIncompleteModal()" class="btn-next">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <!-- üü¢ Summary Modal (New) -->
  <div id="summaryModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeSummaryModal()">&times;</span>
        <h2 style="font-size:1.5rem; margin-bottom:20px; color:#ea580c;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°</h2>
        <div id="summaryList" style="margin-top:15px; max-height:400px; overflow-y:auto;">
             <!-- Content injected by JS -->
        </div>
      </div>
  </div>
  
  <!-- üü¢ Delete Option Modal (New) -->
  <div id="deleteOptionModal" class="modal">
      <div class="modal-content" style="text-align:center;">
          <span class="close-modal" onclick="closeDeleteModal()">&times;</span>
          <h2 style="color:var(--danger); margin-bottom:20px;">üóëÔ∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö?</h2>
          <div style="display:flex; flex-direction:column; gap:12px;">
              <button onclick="deleteCurrentMonth()" class="primary" style="background:#fee2e2; color:#b91c1c; border:1px solid #fca5a5;">üìÖ ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
              <button onclick="clearAllHistory()" class="primary" style="background:#ef4444; color:white; box-shadow:0 4px 10px rgba(239, 68, 68, 0.4);">üí• ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
          <button onclick="closeDeleteModal()" class="btn-next" style="margin-top:20px; width:100%;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
  </div>

</div>

<script>
  /* ===== 1. Global Utilities & Helpers (Moved to Top for Safety) ===== */
  let currentHistoryMode = 'daily'; // 'daily' or 'driver'
  let historyFilters = { daily: { month: null, driver: "" }, driver: { month: null, driver: "" } }; 
  
  // üü¢ Custom Picker State
  let pickerTargetId = null;
  let pickerDisplayId = null;
  let pickerCurrentDate = new Date();
  
  // üü¢ SHORT MONTHS for Picker Buttons
  const THAI_MONTHS_SHORT = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
  // üü¢ FULL MONTHS for Display Header
  const THAI_MONTHS_FULL = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

  function updateRadioStyle() {
    document.querySelectorAll('.radio-line label').forEach(lbl => {
        const rad = lbl.querySelector('input[type="radio"]');
        if(rad && rad.checked) lbl.classList.add('active');
        else lbl.classList.remove('active');
    });
  }
  
  // üü¢ FIX: Directly Toggle Menu in JS
  function toggleSummaryMenu(event) {
      if(event) event.stopPropagation();
      const menu = document.getElementById('summaryMenu');
      if(menu) {
          menu.classList.toggle('show');
      }
  }

  // üü¢ Sidebar Submenu Toggle Logic
  function toggleSidebarSubmenu(id) {
      const submenu = document.getElementById(id);
      const parent = submenu.parentElement.querySelector('.menu-item');
      if (submenu) {
          if (submenu.classList.contains('open')) {
              submenu.classList.remove('open');
              parent.classList.remove('expanded');
          } else {
              submenu.classList.add('open');
              parent.classList.add('expanded');
          }
      }
  }

  // Close dropdown when clicking outside
  window.onclick = function(event) {
      // Handle Modal closing
      const modal = document.getElementById('detailModal');
      const deleteModal = document.getElementById('deleteOptionModal');
      const summaryModal = document.getElementById('summaryModal');
      const incompleteModal = document.getElementById('incompleteModal');
      const driverModal = document.getElementById('addDriverModal');
      const createOptModal = document.getElementById('createOptionModal');
      const customMonthModal = document.getElementById('customMonthPickerModal');
      
      if (event.target == modal) closeModal();
      if (event.target == deleteModal) closeDeleteModal();
      if (event.target == summaryModal) closeSummaryModal();
      if (event.target == incompleteModal) closeIncompleteModal();
      if (event.target == driverModal) closeAddDriverModal();
      if (event.target == createOptModal) closeCreateOptionModal();
      if (event.target == customMonthModal) closeCustomMonthPicker();
      
      // üü¢ FIX: Close Dropdown if clicked outside
      if (!event.target.closest('#historyTitleBtn')) {
          const menu = document.getElementById('summaryMenu');
          if (menu && menu.classList.contains('show')) {
              menu.classList.remove('show');
          }
      }
  };
  
  // üü¢ CUSTOM MONTH PICKER FUNCTIONS
  function openCustomMonthPicker(inputId, displayId) {
    pickerTargetId = inputId;
    pickerDisplayId = displayId;
    
    const input = document.getElementById(inputId);
    if(input && input.value) {
        // value is YYYY-MM
        const [y, m] = input.value.split('-');
        pickerCurrentDate = new Date(parseInt(y), parseInt(m)-1, 1);
    } else {
        pickerCurrentDate = new Date();
    }
    
    renderCustomPicker();
    document.getElementById('customMonthPickerModal').classList.add('show');
  }

  function closeCustomMonthPicker() {
    document.getElementById('customMonthPickerModal').classList.remove('show');
  }

  function adjustPickerYear(offset) {
    pickerCurrentDate.setFullYear(pickerCurrentDate.getFullYear() + offset);
    renderCustomPicker();
  }

  function renderCustomPicker() {
    const year = pickerCurrentDate.getFullYear();
    const thaiYear = year + 543;
    document.getElementById('cmpYearDisplay').innerText = thaiYear;
    
    const grid = document.getElementById('cmpMonthGrid');
    grid.innerHTML = '';
    
    // üü¢ Picker uses SHORT names (‡∏°.‡∏Ñ.)
    THAI_MONTHS_SHORT.forEach((m, idx) => {
        const btn = document.createElement('div');
        btn.className = 'cmp-month-btn';
        btn.innerText = m; 
        // Highlight if matches current value
        const input = document.getElementById(pickerTargetId);
        if(input && input.value) {
             const [y, mStr] = input.value.split('-');
             if(parseInt(y) === year && (parseInt(mStr)-1) === idx) {
                 btn.classList.add('active');
             }
        }
        
        btn.onclick = () => selectPickerMonth(idx);
        grid.appendChild(btn);
    });
  }

  function selectPickerMonth(mIndex) {
    const year = pickerCurrentDate.getFullYear();
    const month = String(mIndex + 1).padStart(2, '0');
    const val = `${year}-${month}`;
    
    const input = document.getElementById(pickerTargetId);
    if(input) {
        input.value = val;
        // Trigger logic update manually since hidden inputs don't fire change on script update
        if(pickerTargetId === 'historyMonthPicker') {
            renderHistory();
        } else if (pickerTargetId === 'createTargetMonth') {
            updateCreateMonthDisplay(val);
        }
    }
    
    // Update Display Text immediately
    const display = document.getElementById(pickerDisplayId);
    if(display) {
        // üü¢ Logic: ALWAYS use FULL Month for Display Text (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2568)
        display.innerText = getThaiMonthYearFull(val); 
    }
    
    closeCustomMonthPicker();
  }

  function setHistoryMode(mode) {
      // 1. Save current filter state for the OLD mode
      const dropdown = document.getElementById('historyDriverFilter');
      const monthPicker = document.getElementById('historyMonthPicker');
      
      if(dropdown) {
          historyFilters[currentHistoryMode].driver = dropdown.value;
      }
      if(monthPicker) {
          historyFilters[currentHistoryMode].month = monthPicker.value;
      }

      // 2. Switch Mode
      currentHistoryMode = mode;
      
      // Update Buttons
      document.querySelectorAll('.mvs-btn').forEach(btn => btn.classList.remove('active'));
      if(mode === 'daily') document.getElementById('mvsDaily')?.classList.add('active');
      else document.getElementById('mvsDriver')?.classList.add('active');

      // Update Title Text based on mode
      const titleText = document.getElementById('historyTitleBtn');
      if(titleText) {
          if(mode === 'daily') {
              titleText.innerText = "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
          } else {
              titleText.innerText = "‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏û‡∏Ç‡∏£.";
          }
      }
      
      // Highlight active submenu item
      document.querySelectorAll('.submenu-item').forEach(el => el.classList.remove('active'));
      
      // üü¢ Toggle Toolbar Visibility based on Mode
      const toolbar = document.getElementById('historyToolbar');
      if(toolbar) {
          if(mode === 'daily') {
              toolbar.style.display = 'flex';
          } else {
              toolbar.style.display = 'none';
          }
      }

      // 3. Restore filter state for the NEW mode
      if(dropdown) {
          dropdown.value = historyFilters[mode].driver || "";
      }
      if(monthPicker) {
          if(historyFilters[mode].month) {
               monthPicker.value = historyFilters[mode].month;
          } else {
               const now = new Date();
               const mStr = String(now.getMonth() + 1).padStart(2, '0');
               monthPicker.value = `${now.getFullYear()}-${mStr}`;
          }
          // Update Display
          const display = document.getElementById('historyDateDisplay');
          // üü¢ FIX: Use FULL Month
          if(display) display.innerText = getThaiMonthYearFull(monthPicker.value);
      }

      renderHistory();
  }

  function handleFilterChange() {
      const dropdown = document.getElementById('historyDriverFilter');
      if(dropdown) {
          // Update the state immediately
          historyFilters[currentHistoryMode].driver = dropdown.value;
      }
      renderHistory();
  }

  function formatThaiDateDisplay(dateStr) {
    if(!dateStr) return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...';
    const d = new Date(dateStr);
    if(isNaN(d.getTime())) return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...';
      
    // üü¢ Changed to Thai Short Month
    const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    const day = d.getDate();
    const month = months[d.getMonth()];
    const year = (d.getFullYear() + 543) % 100; // Last 2 digits
      
    return `${day} ${month} ${year}`;
  }
  
  function getThaiMonthYearShort(dateStr) {
      if(!dateStr) return '...';
      const [y, m] = dateStr.split('-');
      // üü¢ Changed to Thai Short Month
      const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      return `${months[parseInt(m)-1]} ${(parseInt(y)+543)%100}`;
  }
  
  function getThaiMonthYearFull(dateStr) {
       if(!dateStr) return '...';
      const [y, m] = dateStr.split('-');
      const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      return `${months[parseInt(m)-1]} ${parseInt(y)+543}`;
  }

  function updateCreateMonthDisplay(val) {
      const display = document.getElementById('createMonthDisplay');
      if(display) display.innerText = val ? getThaiMonthYearFull(val) : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...';
  }

  function formatDateForInputBox(dateStr) {
    if(!dateStr) return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...';
    const d = new Date(dateStr);
    if(isNaN(d.getTime())) return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...';
      
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear() + 543;
      
    return `${day}/${month}/${year}`;
  }

  function formatThaiDate(dateStr) {
    if(!dateStr) return '-';
    const d = new Date(dateStr);
    if(isNaN(d.getTime())) return '-';
      
    const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      
    const day = d.getDate();
    const month = months[d.getMonth()];
    const year = (d.getFullYear() + 543) % 100; 
      
    return `${day} ${month} ${year}`;
  }

  function syncDateDisplay(inputId, displayId) {
      const input = document.getElementById(inputId);
      const display = document.getElementById(displayId);
      if(input && display) {
          display.textContent = formatDateForInputBox(input.value);
      }
  }

  function updateThaiDateDisplay() {
    const workDateEl = document.getElementById('workDate');
    if (!workDateEl) return; // Guard clause

    const inputVal = workDateEl.value;
    const label = document.getElementById('dateLabel');

    if (inputVal) { 
        const d = new Date(inputVal);
        const day = d.getDay();
        const typeVal = (day===0||day===6)?'weekend':'weekday';
        const rad = document.querySelector(`input[name="type"][value="${typeVal}"]`);
        if(rad) { rad.checked=true; updateRadioStyle(); }
        
        if(label) {
            label.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDateDisplay(inputVal)}`;
            label.style.color = 'var(--brand)';
        }
    }
    syncDateDisplay('workDate', 'workDateShow');
  }

  function formatTimeInput(e) {
    let v = e.target.value.replace(/[^0-9]/g, '');
    if (v.length > 4) v = v.substring(0,4);
    if (v.length > 2) e.target.value = v.substring(0,2) + ':' + v.substring(2);
    else e.target.value = v;
  }

  function validateTimeInput(e) {
    let v = e.target.value;
    if(!v.includes(':') && v.length === 4) { 
        v = v.substring(0,2) + ':' + v.substring(2); 
        e.target.value = v; 
    }
    const parts = v.split(':');
    if(parts.length === 2) {
        let h = parseInt(parts[0]);
        let m = parseInt(parts[1]);
        if (isNaN(h)) h = 0;
        if (isNaN(m)) m = 0;
        if (h > 24) h = 24;
        if (m > 59) m = 59;
        e.target.value = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }
  }

  // üü¢ New Helper for Date String
  function getDateString(year, month, day) {
      const m = String(month).padStart(2, '0');
      const d = String(day).padStart(2, '0');
      return `${year}-${m}-${d}`;
  }

  /* ===== 2. Global State & Data Logic ===== */
  let currentCalcResult = null; 
  let otHistory = [];
  let rawDrivers = JSON.parse(localStorage.getItem('egat_drivers')) || [];
  let drivers = [];
   
  if(rawDrivers.length > 0 && typeof rawDrivers[0] === 'string') {
      drivers = rawDrivers.map(d => ({ id: Date.now() + Math.random(), name: d, nickname: '', phone: '', affiliation: '', department: '' }));
      localStorage.setItem('egat_drivers', JSON.stringify(drivers));
  } else {
      drivers = rawDrivers;
  }

  let editingRowIndex = null; 
  let showAll = false;
  let filteredIndices = [];
  try { otHistory = JSON.parse(localStorage.getItem('egat_ot_history')) || []; } catch(e) {}
  
  // Sort Init
  otHistory.sort((a, b) => {
      const nameA = a.driver || "";
      const nameB = b.driver || "";
      const nameCompare = nameA.localeCompare(nameB, 'th');
      if (nameCompare !== 0) return nameCompare;
      return new Date(a.date) - new Date(b.date);
  });

  const WORKDAY_MINUTES = 8*60;
  const LUNCH_BREAK_MIN = 60;
  const DINNER_BREAK_MIN = 30;

  /* ===== 3. Global Action Functions (Must be defined before HTML calls them) ===== */
  
  // Navigation
  function switchView(viewId) {
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
    
    // Handle menu highlight
    if(viewId === 'ot') document.querySelector('.menu-item[onclick*="ot"]').classList.add('active');
    if(viewId === 'drivers') document.querySelector('.menu-item[onclick*="drivers"]').classList.add('active');
    if(viewId === 'calc') document.querySelector('.menu-item[onclick*="calc"]').classList.add('active');
    
    // Special handling for history group
    if(viewId === 'history') {
        const historyGroupItem = document.querySelector('.menu-item-group .menu-item');
        if(historyGroupItem) historyGroupItem.classList.add('active');
    }

    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
      
    if(viewId === 'history') {
        showAll = false;
        
        // Restore State for Default View
        setHistoryMode(currentHistoryMode);
        
        // Ensure Default State
        const toolbar = document.getElementById('historyToolbar');
        if(toolbar) {
            if(currentHistoryMode === 'daily') toolbar.style.display = 'flex';
            else toolbar.style.display = 'none';
        }
    }
    if(viewId === 'drivers') {
        renderDriverPageList();
    }
  }

  function updateBadge() {
    const badge = document.getElementById('historyCount');
    if(otHistory.length > 0) {
        badge.innerText = otHistory.length;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
  }

  // Drivers
  function renderDrivers() {
    const driverSelect = document.getElementById('driverSelect');
    const historyDriverFilter = document.getElementById('historyDriverFilter'); // üü¢ Re-added

    if(driverSelect) {
        const currentVal = driverSelect.value;
        driverSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>';
        drivers.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.name;
          let label = d.name;
          if(d.nickname) label += ` (${d.nickname})`;
          opt.textContent = label;
          driverSelect.appendChild(opt);
        });
        if(drivers.some(d => d.name === currentVal)) driverSelect.value = currentVal;
    }
    
    // üü¢ Update History Filter Dropdown
    if(historyDriverFilter) {
        // Save current value before rebuilding options if needed, but usually we just want to rebuild list.
        // Actually, we should only rebuild options if the list changed. But here we do it every time.
        // We must preserve the selected value.
        const currentFilter = historyDriverFilter.value;
        
        historyDriverFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        drivers.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.name;
          let label = d.name;
          if(d.nickname) label += ` (${d.nickname})`;
          opt.textContent = label;
          historyDriverFilter.appendChild(opt);
        });
        
        // If current value is valid, keep it.
        if(currentFilter && drivers.some(d => d.name === currentFilter)) {
             historyDriverFilter.value = currentFilter;
        } else {
             // If not valid (e.g. driver deleted), or first load, check state.
             // We should sync with current mode's state filter
             historyDriverFilter.value = historyFilters[currentHistoryMode].driver || "";
        }
    }

    renderDriverPageList();
  }

  function renderDriverPageList() {
      const container = document.getElementById('driverListContainer');
      if(!container) return;
      
      // üü¢ CHANGE: Use driver-list-container instead of grid
      container.className = 'driver-list-container';
      
      if(drivers.length === 0) {
          container.innerHTML = '<div style="padding:60px; text-align:center; color:#94a3b8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£. <br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</div>';
          return;
      }
      container.innerHTML = '';
      drivers.forEach((d, index) => {
          const item = document.createElement('div');
          item.className = 'driver-item-row'; // Use Row Class
          
          let nicknameStr = d.nickname ? `(${d.nickname})` : '';
          
          let detailsHtml = '';
          if(d.phone) detailsHtml += `<span>üìû ${d.phone}</span>`;
          if(d.affiliation || d.department) detailsHtml += `<span>üè¢ ${d.affiliation} ${d.department}</span>`;
          if(detailsHtml === '') detailsHtml = '<span style="opacity:0.4;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -</span>';

          item.innerHTML = `
            <div class="d-index">${index + 1}</div>
            <div class="d-info">
                <div class="d-main">${d.name} <span style="font-weight:400; color:var(--text-muted); font-size:0.9rem;">${nicknameStr}</span></div>
                <div class="d-sub">${detailsHtml}</div>
            </div>
            <div class="d-actions">
                <button onclick="editDriver('${d.id}')" class="action-btn-sm btn-view-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                <button onclick="removeDriverByName('${d.name}')" class="action-btn-sm btn-reset-sm" style="color:#ef4444; background:#fef2f2;" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          `;
          container.appendChild(item);
      });
  }

  // Driver Modals
  function openAddDriverModal() {
      document.getElementById('editDriverId').value = '';
      document.getElementById('driverModalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£. ‡πÉ‡∏´‡∏°‡πà';
      document.getElementById('dName').value = '';
      document.getElementById('dNick').value = '';
      document.getElementById('dPhone').value = '';
      document.getElementById('dAff').value = '';
      document.getElementById('dDept').value = '';
      document.getElementById('addDriverModal').classList.add('show');
      document.getElementById('dName').focus();
  }
   
  function editDriver(id) {
      const d = drivers.find(drv => drv.id.toString() === id.toString());
      if(!d) return;
      document.getElementById('editDriverId').value = d.id;
      document.getElementById('driverModalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏û‡∏Ç‡∏£.';
      document.getElementById('dName').value = d.name;
      document.getElementById('dNick').value = d.nickname || '';
      document.getElementById('dPhone').value = d.phone || '';
      document.getElementById('dAff').value = d.affiliation || '';
      document.getElementById('dDept').value = d.department || '';
      document.getElementById('addDriverModal').classList.add('show');
  }
   
  function closeAddDriverModal() {
      document.getElementById('addDriverModal').classList.remove('show');
  }

  function saveDriver() {
      const id = document.getElementById('editDriverId').value;
      const nameInp = document.getElementById('dName');
      const nickInp = document.getElementById('dNick');
      const phoneInp = document.getElementById('dPhone');
      const affInp = document.getElementById('dAff');
      const deptInp = document.getElementById('dDept');

      const name = nameInp.value.trim();
      if(!name) { alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'); return; }

      const isDuplicate = drivers.some(d => d.name === name && d.id.toString() !== id);
      if(isDuplicate) { alert('‚ùå ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }

      if(id) {
          const index = drivers.findIndex(d => d.id.toString() === id);
          if(index !== -1) {
              drivers[index].name = name;
              drivers[index].nickname = nickInp.value.trim();
              drivers[index].phone = phoneInp.value.trim();
              drivers[index].affiliation = affInp.value.trim();
              drivers[index].department = deptInp.value.trim();
          }
      } else {
          const newDriver = {
              id: Date.now(),
              name: name,
              nickname: nickInp.value.trim(),
              phone: phoneInp.value.trim(),
              affiliation: affInp.value.trim(),
              department: deptInp.value.trim()
          };
          drivers.push(newDriver);
      }
      localStorage.setItem('egat_drivers', JSON.stringify(drivers));
      renderDrivers();
      closeAddDriverModal();
      
      nameInp.value = ''; nickInp.value = ''; phoneInp.value = ''; affInp.value = ''; deptInp.value = '';
  }
   
  function removeDriverByName(name) {
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ "' + name + '" ?')) {
          drivers = drivers.filter(d => d.name !== name);
          localStorage.setItem('egat_drivers', JSON.stringify(drivers));
          renderDrivers();
      }
  }

  // Calc Logic
  const MIN = (h,m)=>h*60+m;
  const toMinutes = t => { if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m; };
    
  function getEffectiveDriver() {
      const historyView = document.getElementById('view-history');
      const driverSelect = document.getElementById('driverSelect');
      const historyFilter = document.getElementById('historyDriverFilter');
      if (historyView && historyView.classList.contains('active')) {
          if (historyFilter && historyFilter.value !== "") {
              return historyFilter.value;
          }
      }
      return driverSelect ? driverSelect.value : "";
  }

  const fmt = mins => {
      const h = Math.floor(mins/60);
      const m = mins%60;
      return m > 0 ? `${h} ‡∏ä‡∏°. ${m} ‡∏ô.` : `${h} ‡∏ä‡∏°.`;
  };
    
  const fmtShort = mins => {
      if(!mins || mins===0) return '-';
      return (mins/60).toFixed(1).replace('.0','');
  };

  const fmtTime = mins => { const h = Math.floor(mins/60)%24; const m = mins%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };

  function rowHTML(range, rateClass, rateText, mins){
    return `<div class="row"><div class="time">${range}</div><div class="rate ${rateClass}">${rateText}</div><div class="dur">${fmt(mins)}</div></div>`;
  }

  function generateResultHTML(type, dateVal, startMin, endMin, totalMinutes, wkResult) {
      const thaiDate = formatThaiDate(dateVal);
      const timeRange = `${fmtTime(startMin)} - ${fmtTime(endMin)}`;
      const head = `<div class="result-head"><div class="tt">‡∏™‡∏£‡∏∏‡∏õ</div><div class="meta-pill"><span class="m-date">üìÖ ${thaiDate}</span><span class="m-time">‚è∞ ${timeRange}</span></div></div>`;
      let body = '';

      if (type === 'weekday') {
          body = `<div class="result-section"><div class="result-title"><span class="i">üîî</span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô OT √ó1.5</div><div class="rows">${wkResult.rowsHTML || '<div class="note-sub">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö</div>'}</div>${wkResult.breaks.length?`<div class="breaks">${wkResult.breaks.map(b=>`<span class="break-chip">${b}</span>`).join('')}</div>`:''}</div><div class="result-section"><div class="total-box"><div class="total-line"><span class="k">‡∏£‡∏ß‡∏° √ó1.5</span><span class="v">${fmt(wkResult.total15)}</span></div><div class="total-line em"><span class="k">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</span><span class="v">${fmt(Math.max(0, totalMinutes - WORKDAY_MINUTES))}</span></div></div></div>`;
      } else {
          const ot1 = wkResult.totals[1] || 0;
          const ot3 = wkResult.totals[3] || 0;
          body = `<div class="result-section"><div class="result-title"><span class="i">üîî</span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏ï‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</div><div class="rows">${wkResult.rowsHTML || '<div class="note-sub">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö</div>'}</div>${wkResult.breaks.length?`<div class="breaks">${wkResult.breaks.map(b=>`<span class="break-chip">${b}</span>`).join('')}</div>`:''}</div><div class="result-section"><div class="total-box"><div class="total-line"><span class="k">‡∏£‡∏ß‡∏° √ó3</span><span class="v">${fmt(ot3)}</span></div><div class="total-line"><span class="k">‡∏£‡∏ß‡∏° √ó1</span><span class="v">${fmt(ot1)}</span></div><div class="total-line em"><span class="k">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</span><span class="v">${fmt(wkResult.totalMinutes)}</span></div></div></div>`;
      }
      return `<div class="result-wrap" style="outline:none;">${head}${body}</div>`;
  }

  function calculateCore(start, end, dateVal, type) {
      if(!start || !end || !dateVal) return null;
      let startMin = toMinutes(start);
      let endMin = toMinutes(end);
      if (endMin < startMin || end.startsWith('00:')) endMin += 24 * 60; 
      if (startMin > 720 && startMin < 780) startMin = 780;
      if (endMin > 720 && endMin < 780) endMin = 720;
      startMin = Math.ceil(startMin / 30) * 30;
      endMin = Math.floor(endMin / 30) * 30;
      if(endMin <= startMin) return null;

      let totalMinutes = endMin - startMin;
      if(Math.max(0,Math.min(endMin,MIN(13,0))-Math.max(startMin,MIN(12,0)))>0) totalMinutes-=LUNCH_BREAK_MIN;
      if(endMin>=MIN(19,30)) totalMinutes-=DINNER_BREAK_MIN;

      const timeRange = `${fmtTime(startMin)} - ${fmtTime(endMin)}`;
      let ot15=0, ot1=0, ot3=0, html = '', maxOTMinutes = 0;

      if(type === 'weekday'){
          const wk15 = computeWeekday15(startMin, endMin); 
          ot15 = wk15.total15; 
          html = generateResultHTML(type, dateVal, startMin, endMin, totalMinutes, wk15);
          maxOTMinutes = wk15.total15;
      } else {
          const wk = computeWeekend(startMin, endMin);
          ot1 = wk.totals[1] || 0;
          ot3 = wk.totals[3] || 0;
          html = generateResultHTML(type, dateVal, startMin, endMin, totalMinutes, wk);
          maxOTMinutes = (wk.totals[1]||0) + (wk.totals[3]||0);
      }
      return { date: dateVal, type: type, timeRange: timeRange, start: start, end: end, ot15: ot15, ot1: ot1, ot3: ot3, html: html, maxOTMinutes: maxOTMinutes };
  }

  function computeWeekday15(startMin,endMin){
    const sessions=[[MIN(0,0),MIN(8,0)],[MIN(17,0),MIN(24,0)],[MIN(24,0),MIN(32,0)]]; 
    let total15=0, rowsHTML='', breaks=[];
    for(const [s,e] of sessions){
      const from=Math.max(startMin,s), to=Math.min(endMin,e), ov=Math.max(0,to-from);
      if(ov>0){
        const f=fmtTime(from); const t=fmtTime(to);
        rowsHTML += rowHTML(`${f}‚Äì${t}`,'x15','√ó1.5',ov);
        total15 += ov;
      }
    }
    if(endMin>=MIN(19,30)){ total15=Math.max(0,total15-DINNER_BREAK_MIN); breaks.push('‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ (19:30‚Äì20:00)'); }
    return { rowsHTML, breaks, total15 };
  }

  function computeWeekend(startMin,endMin,totalMinutes){
    const sess=[[MIN(0,0),MIN(8,0),3],[MIN(8,0),MIN(17,0),1],[MIN(17,0),MIN(24,0),3],[MIN(24,0),MIN(32,0),3]];
    let rowsHTML='', totals={1:0,3:0}, breaks=[];
    for(const [s,e,r] of sess){
      const from=Math.max(startMin,s), to=Math.min(endMin,e), ov=Math.max(0,to-from);
      if(ov>0){
        const f=fmtTime(from); const t=fmtTime(to);
        rowsHTML += rowHTML(`${f}‚Äì${t}`, r===3?'x3':'x1', `√ó${r}`, ov);
        totals[r]=(totals[r]||0)+ov;
      }
    }
    const L1=MIN(12,0), L2=MIN(13,0);
    if(Math.max(0,Math.min(endMin,L2)-Math.max(startMin,L1))>0){
      totals[1]=Math.max(0,(totals[1]||0)-LUNCH_BREAK_MIN); breaks.push('‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏Å 1 ‡∏ä‡∏°. (12:00‚Äì13:00)');
    }
    if(endMin>=MIN(19,30)){ totals[3]=Math.max(0,(totals[3]||0)-DINNER_BREAK_MIN); breaks.push('‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏Å 30 ‡∏ô. (19:30‚Äì20:00)'); }
    const totalCalc = (totals[1]||0) + (totals[3]||0);
    return { rowsHTML, breaks, totals, totalMinutes: totalCalc };
  }

  function sortHistory() {
      otHistory.sort((a, b) => {
          const nameA = a.driver || "";
          const nameB = b.driver || "";
          const nameCompare = nameA.localeCompare(nameB, 'th');
          if (nameCompare !== 0) return nameCompare;
          return new Date(a.date) - new Date(b.date);
      });
  }

  function calculateOT(){
    const start = document.getElementById('startTime').value;
    const end   = document.getElementById('endTime').value;
    const dateVal = document.getElementById('workDate').value;
    const type  = document.querySelector('input[name="type"]:checked').value;
    const driver = document.getElementById('driverSelect').value;
      
    if(!start || !end || !dateVal) { document.getElementById('result').innerText='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
    const result = calculateCore(start, end, dateVal, type); 
    if(!result) { document.getElementById('result').innerText='‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; return; }

    currentCalcResult = { ...result, id: Date.now(), driver: driver };
    document.getElementById('result').innerHTML = result.html;
    document.getElementById('saveSection').style.display = 'flex';
    const btn = document.getElementById('btnSaveLog');
    btn.innerHTML = 'üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    btn.style.background = 'var(--success)';
    btn.disabled = false;
  }

  function resetFormForNext() {
    document.getElementById('startTime').value = '07:30';
    document.getElementById('endTime').value    = '17:00';
    document.getElementById('result').innerHTML = '';
    document.getElementById('saveSection').style.display = 'none';
    currentCalcResult = null;
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
  }

  function editInline(index) {
      editingRowIndex = index;
      renderHistory(); 
  }

  function saveInline(index) { 
      const dateInp = document.getElementById('editDate').value;
      const startInp = document.getElementById('editStart').value;
      const endInp = document.getElementById('editEnd').value;
      const originalItem = otHistory[index];

      if(!dateInp) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }

      const d = new Date(dateInp);
      const day = d.getDay();
      let newType = (day === 0 || day === 6) ? 'weekend' : 'weekday';
      if (dateInp === originalItem.date) newType = originalItem.type;

      const newResult = calculateCore(startInp, endInp, dateInp, newType);

      if(newResult) {
          newResult.id = originalItem.id;
          newResult.driver = originalItem.driver; 
          newResult.isPending = false; 
          otHistory[index] = newResult;
          
          sortHistory(); 
          try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e) {}
            
          const driverFilterVal = document.getElementById('historyDriverFilter').value;
          let targetMonth = null;
          let targetYear = null;
          if (!showAll) {
              const workDateVal = document.getElementById('workDate').value;
              if (workDateVal) {
                  const d = new Date(workDateVal);
                  targetMonth = d.getMonth();
                  targetYear = d.getFullYear();
              }
          }

          const currentFiltered = otHistory.filter(item => {
              if(!showAll && targetMonth !== null) {
                  const d = new Date(item.date);
                  if(d.getMonth() !== targetMonth || d.getFullYear() !== targetYear) return false;
              }
              if (driverFilterVal !== "" && (item.driver||"") !== driverFilterVal) return false;
              return true;
          });

          const currentFilteredIndex = currentFiltered.findIndex(item => item.id === newResult.id);
          if (currentFilteredIndex !== -1 && currentFilteredIndex < currentFiltered.length - 1) {
              const nextItem = currentFiltered[currentFilteredIndex + 1];
              const nextIndexInMain = otHistory.findIndex(item => item.id === nextItem.id);
              if(nextIndexInMain !== -1) {
                  editingRowIndex = nextIndexInMain;
              } else {
                  editingRowIndex = null;
              }
          } else {
              editingRowIndex = null;
          }
          renderHistory();
      } else {
          alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
  }

  function moveInline(step) {
      const currentVisualIndex = filteredIndices.indexOf(editingRowIndex);
      if (currentVisualIndex !== -1) {
          const nextVisualIndex = currentVisualIndex + step;
          if (nextVisualIndex >= 0 && nextVisualIndex < filteredIndices.length) {
              editingRowIndex = filteredIndices[nextVisualIndex];
              renderHistory();
          }
      }
  }

  function cancelInline() {
      editingRowIndex = null;
      renderHistory();
  }

  function showAllHistory() {
    showAll = true;
    renderHistory();
  }

  function resetCurrentMonth() {
      const driverFilterVal = document.getElementById('historyDriverFilter').value;
      let targetMonth = null;
      let targetYear = null;
      if (!showAll) {
          const workDateVal = document.getElementById('workDate').value;
          if (workDateVal) {
              const d = new Date(workDateVal);
              targetMonth = d.getMonth();
              targetYear = d.getFullYear();
          }
      }
      if(!showAll && targetMonth === null) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
      const confirmMsg = showAll ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"?` : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?`;
      if(!confirm(confirmMsg)) return;

      let count = 0;
      otHistory.forEach(item => {
          let isMatch = true;
          if (!showAll) {
              const d = new Date(item.date);
              if(d.getMonth() !== targetMonth || d.getFullYear() !== targetYear) isMatch = false;
          }
          if (driverFilterVal !== "" && (item.driver||"") !== driverFilterVal) isMatch = false;
          if(isMatch) {
              item.isPending = true; item.isLeave = false;
              delete item.leaveType; delete item.isIncomplete; delete item.incompleteReason;
              item.start = '07:30'; item.end = '17:00'; item.ot15 = 0; item.ot1 = 0; item.ot3 = 0;
              count++;
          }
      });
      localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
      renderHistory();
      alert(`‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  }

  // üü¢ Delete Option Logic
  function openDeleteModal() {
      document.getElementById('deleteOptionModal').classList.add('show');
  }

  function closeDeleteModal() {
      document.getElementById('deleteOptionModal').classList.remove('show');
  }

  function deleteCurrentMonth() {
      // Logic for "Delete This Month" triggered from Modal
      // Close modal first
      closeDeleteModal();

      const driverFilterVal = document.getElementById('historyDriverFilter').value;
      let targetMonth = null;
      let targetYear = null;
      if (!showAll) {
          const workDateVal = document.getElementById('workDate').value;
          if (workDateVal) {
              const d = new Date(workDateVal);
              targetMonth = d.getMonth();
              targetYear = d.getFullYear();
          }
      }
      const confirmMsg = showAll ? `‚ö†Ô∏è ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"?` : `‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?`;
      if(!confirm(confirmMsg)) return;

      const initialLen = otHistory.length;
      otHistory = otHistory.filter(item => {
          let isMatch = true;
          if (!showAll) {
              const d = new Date(item.date);
              if(d.getMonth() !== targetMonth || d.getFullYear() !== targetYear) isMatch = false;
          }
          if (driverFilterVal !== "" && (item.driver||"") !== driverFilterVal) isMatch = false;
          return !isMatch;
      });
      const deletedCount = initialLen - otHistory.length;
      localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
      renderHistory();
      updateBadge();
      alert(`‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  }

  function clearAllHistory() {
      // Logic for "Reset All" triggered from Modal
      closeDeleteModal();

      if(confirm('‚õîÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
          if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞?')) {
              otHistory = [];
              localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
              renderHistory();
              updateBadge();
          }
      }
  }

  function resetHistoryItem(index) {
      if(!confirm('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Pending)?')) return;
      const item = otHistory[index];
      item.isPending = true;
      item.start = '07:30'; item.end = '17:00'; item.ot15 = 0; item.ot1 = 0; item.ot3 = 0;
      localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
      renderHistory();
  }

  function openIncompleteModal() {
      const sel = document.getElementById('incDriverSelect');
      sel.innerHTML = '';
      drivers.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.name;
          opt.textContent = d.name + (d.nickname ? ` (${d.nickname})` : '');
          sel.appendChild(opt);
      });
      const current = getEffectiveDriver();
      if(current && drivers.some(d => d.name === current)) sel.value = current;
      const workDateVal = document.getElementById('workDate').value;
      if(workDateVal) {
          document.getElementById('incMonth').value = workDateVal.substring(0, 7);
      } else {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth()+1).padStart(2,'0');
          document.getElementById('incMonth').value = `${y}-${m}`;
      }
      document.getElementById('incNote').value = '';
      renderIncDays();
      document.getElementById('incompleteModal').classList.add('show');
  }

  function closeIncompleteModal() {
      document.getElementById('incompleteModal').classList.remove('show');
  }

  function renderIncDays() {
      const monthVal = document.getElementById('incMonth').value;
      const grid = document.getElementById('incDaysGrid');
      grid.innerHTML = '';
      if(!monthVal) return;
      const [year, month] = monthVal.split('-').map(Number); 
      const daysInMonth = new Date(year, month, 0).getDate();
      for(let i=1; i<=daysInMonth; i++) {
          const div = document.createElement('div');
          div.className = 'day-item';
          div.textContent = i;
          div.onclick = function() { this.classList.toggle('selected'); };
          grid.appendChild(div);
      }
  }

  function resolveIncomplete(index) {
      if(confirm('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
          const item = otHistory[index];
          delete item.isIncomplete; delete item.incompleteReason;
          try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e){}
          renderHistory();
      }
  }

  function addIncNoteText(text) {
      const el = document.getElementById('incNote');
      const current = el.value.trim();
      if(current) el.value = current + ', ' + text; else el.value = text;
      el.focus();
  }

  function saveIncompleteReport() {
      const driver = document.getElementById('incDriverSelect').value;
      const monthVal = document.getElementById('incMonth').value;
      const note = document.getElementById('incNote').value.trim();
      const selectedEls = document.querySelectorAll('#incDaysGrid .day-item.selected');
      let targetDays = [];
      selectedEls.forEach(el => targetDays.push(parseInt(el.textContent)));

      if(!driver) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
      if(!monthVal) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'); return; }
      if(targetDays.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'); return; }
      if(!note) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î'); return; }

      const [year, month] = monthVal.split('-').map(Number);
      targetDays.sort((a,b)=>a-b);
      let updatedCount = 0; let newCount = 0;

      targetDays.forEach(dayNum => {
          const dateString = getDateString(year, month, dayNum);
          const driverName = driver.trim();
          
          // üü¢ Robust Find: Check Exact Match (Trimmed) OR Orphan (No Name)
          let existingItem = otHistory.find(item => 
              item.date === dateString && 
              (item.driver || "").trim() === driverName
          );
          
          // If not found, try finding an orphan to claim
          if (!existingItem) {
              existingItem = otHistory.find(item => item.date === dateString && !item.driver);
          }

          if(existingItem) {
              existingItem.driver = driver; 
              existingItem.isIncomplete = true;
              existingItem.incompleteReason = note;
              updatedCount++;
          } else {
               const newItem = {
                  id: Date.now() + dayNum, date: dateString, type: 'weekday', driver: driver,
                  isPending: true, isIncomplete: true, incompleteReason: note,
                  ot15: 0, ot1: 0, ot3: 0, start: '07:30', end: '17:00'
              };
              otHistory.push(newItem);
              newCount++;
          }
      });
      sortHistory();
      try {
          localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
          renderHistory();
          closeIncompleteModal();
          alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${updatedCount}\n- ‡πÉ‡∏´‡∏°‡πà: ${newCount}`);
      } catch(e) { alert('Error saving'); }
  }
  
  // üü¢ New Function: View Missing Details (Clickable Alert)
  window.viewDriverMissing = function(driverName) {
    const listContainer = document.getElementById('summaryList');
    listContainer.innerHTML = '';
    
    // 1. Find Driver Details for Phone Number
    const driverObj = drivers.find(d => d.name === driverName);
    const phone = driverObj ? driverObj.phone : '-';

    // Header
    const header = document.createElement('div');
    header.style.marginBottom = '15px';
    header.style.borderBottom = '1px solid #e2e8f0';
    header.style.paddingBottom = '10px';
    header.innerHTML = `
        <div style="font-weight:800; font-size:1.1rem; color:var(--brand);">üë§ ${driverName}</div>
        <div style="font-size:0.9rem; color:var(--text-muted);">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: <span style="color:var(--text-main); font-weight:600;">${phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span></div>
    `;
    listContainer.appendChild(header);

    // Filter Logic matches renderHistory
    let targetMonth = null;
    let targetYear = null;
      
    if (!showAll) {
        // üü¢ FIX: Use history picker value
        const historyPickerVal = document.getElementById('historyMonthPicker').value;
        if (historyPickerVal) {
            const [y, m] = historyPickerVal.split('-');
            targetMonth = parseInt(m) - 1;
            targetYear = parseInt(y);
        }
    }

    const items = otHistory.filter(item => {
        if(!item.isIncomplete) return false;
        // Check Name
        const dName = item.driver || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)";
        if(dName !== driverName) return false;

        // Check Date
        if (!showAll && targetMonth !== null) {
             const d = new Date(item.date);
             if (d.getMonth() !== targetMonth || d.getFullYear() !== targetYear) return false;
        }
        return true;
    });
    
    if(items.length === 0) {
         listContainer.innerHTML += '<div style="text-align:center; color:#94a3b8; padding:20px;">üéâ ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!</div>';
    } else {
         items.sort((a,b) => new Date(a.date) - new Date(b.date)); // Sort by date
         items.forEach(item => {
            // Find original index to pass to resolve function
            const originalIndex = otHistory.indexOf(item); 

            const el = document.createElement('div');
            el.className = 'summary-list-item';
            el.style.display = 'flex';
            el.style.justifyContent = 'space-between';
            el.style.alignItems = 'center';
            el.style.gap = '10px';
            
            el.innerHTML = `
                <div style="flex:1;">
                    <div class="summary-date">üìÖ ${formatThaiDate(item.date)}</div>
                    <div class="summary-reason" style="margin-top:4px;">${item.incompleteReason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}</div>
                </div>
                <button onclick="resolveFromModal(${originalIndex}, '${driverName}')" 
                        style="border:none; background:#ecfdf5; color:#10b981; width:36px; height:36px; border-radius:10px; cursor:pointer; font-size:1.1rem; flex-shrink:0; display:grid; place-items:center; transition:all 0.2s;"
                        title="‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å)"
                        onmouseover="this.style.background='#d1fae5'" 
                        onmouseout="this.style.background='#ecfdf5'">
                    ‚úî
                </button>
            `;
            listContainer.appendChild(el);
         });
    }

    document.getElementById('summaryModal').classList.add('show');
  };

  // üü¢ Resolve Item from Modal and Refresh List
  window.resolveFromModal = function(index, driverName) {
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß?')) return;

      const item = otHistory[index];
      if(item) {
          delete item.isIncomplete;
          delete item.incompleteReason;
          
          try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e){}
          
          // Refresh Main Table Background
          renderHistory();
          
          // Refresh Modal Content (re-open to update list)
          viewDriverMissing(driverName);
      }
  }

  function openFollowUpSummary() {
    const currentDriver = getEffectiveDriver(); 
    let monthInput = document.getElementById('historyMonthPicker');
    let targetMonth = null, targetYear = null;
    if(monthInput && monthInput.value) {
        const [y, m] = monthInput.value.split('-'); targetYear = parseInt(y); targetMonth = parseInt(m) - 1;
    } else {
        const workDateVal = document.getElementById('workDate').value;
        if(workDateVal) { const d = new Date(workDateVal); targetMonth = d.getMonth(); targetYear = d.getFullYear(); }
    }
    
    const incompleteItems = otHistory.filter(item => {
        if(!item.isIncomplete) return false;
        const d = new Date(item.date);
        if(targetMonth !== null && (d.getMonth() !== targetMonth || d.getFullYear() !== targetYear)) return false;
        if(currentDriver && item.driver !== currentDriver) return false;
        return true;
    });

    const listContainer = document.getElementById('summaryList');
    listContainer.innerHTML = '';
    if(incompleteItems.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">üéâ ‡πÄ‡∏¢‡πâ! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</div>';
    } else {
        incompleteItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'summary-list-item';
            el.innerHTML = `<div><div class="summary-date">üìÖ ${formatThaiDate(item.date)}</div><div class="summary-driver">üë§ ${item.driver || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div></div><div class="summary-reason">${item.incompleteReason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}</div>`;
            listContainer.appendChild(el);
        });
    }
    document.getElementById('summaryModal').classList.add('show');
  }
  
  function closeSummaryModal() { document.getElementById('summaryModal').classList.remove('show'); }

  // üü¢ NEW: Create Option Logic
  function openCreateOptionModal() {
      document.getElementById('createOptionModal').classList.add('show');
      
      // Auto-set the month picker to match the History View's month (more intuitive)
      const historyPickerVal = document.getElementById('historyMonthPicker').value;
      const createPicker = document.getElementById('createTargetMonth');
      if(historyPickerVal && createPicker) {
          createPicker.value = historyPickerVal;
          updateCreateMonthDisplay(historyPickerVal); // üü¢ Update Display Text
      }
  }
  
  function closeCreateOptionModal() {
      document.getElementById('createOptionModal').classList.remove('show');
  }
  
  function initiateAutoFill(mode) {
      // üü¢ Use the new month picker in modal
      const monthVal = document.getElementById('createTargetMonth').value;
      if(!monthVal) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
      
      closeCreateOptionModal();
      
      let targetDrivers = [];
      
      if(mode === 'single') {
          // Use current filter value, NOT main tab
          const filterVal = document.getElementById('historyDriverFilter').value;
          
          if(!filterVal) { 
              // If "All" is selected in filter, fallback to main tab driver
              const mainDriver = document.getElementById('driverSelect').value;
              if(!mainDriver) { 
                  alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏û‡∏Ç‡∏£. ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö\n(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πá‡πÑ‡∏î‡πâ)'); 
                  return; 
              }
              targetDrivers.push(mainDriver);
          } else {
              targetDrivers.push(filterVal);
          }
      } else {
          // All drivers
          if(drivers.length === 0) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£. ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); return; }
          targetDrivers = drivers.map(d => d.name);
      }
      
      const isFullMonth = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${targetDrivers.length} ‡∏ó‡πà‡∏≤‡∏ô \n‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${getThaiMonthYearFull(monthVal)} ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1-31) ?\n\n[‡∏ï‡∏Å‡∏•‡∏á] = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢\n[‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å] = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`);
      if(!isFullMonth) return;
      
      const [yearStr, monthStr] = monthVal.split('-');
      const year = parseInt(yearStr);
      const monthIndex = parseInt(monthStr) - 1; // 0-based
      const lastDay = new Date(year, monthIndex + 1, 0).getDate();
      
      let addedCount = 0;
      const monthForHelper = monthIndex + 1; // 1-based
      
      // Loop through drivers
      targetDrivers.forEach(drvName => {
          for(let dayNum=1; dayNum<=lastDay; dayNum++) {
              const dateString = getDateString(year, monthForHelper, dayNum);
              // Check if exists for this specific driver
              const exists = otHistory.some(item => 
                  item.date === dateString && 
                  ((item.driver || "").trim() === drvName.trim())
              );
              
              if(!exists) {
                  const currentDay = new Date(year, monthIndex, dayNum);
                  const dayOfWeek = currentDay.getDay();
                  const type = (dayOfWeek === 0 || dayOfWeek === 6) ? 'weekend' : 'weekday';
                  const pendingItem = { 
                      id: Date.now() + Math.random(), 
                      date: dateString, 
                      type: type, 
                      driver: drvName, 
                      isPending: true, 
                      ot15: 0, ot1: 0, ot3: 0, 
                      start: '07:30', end: '17:00' 
                  };
                  otHistory.push(pendingItem);
                  addedCount++;
              }
          }
      });
      
      sortHistory();
      try {
          localStorage.setItem('egat_ot_history', JSON.stringify(otHistory));
          updateBadge();
          renderHistory();
          alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${addedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      } catch(e) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
  }

  // üü¢ Old autoFillMonth (redirects to modal logic now, but kept function name for button compatibility if needed, though updated HTML uses openCreateOptionModal)
  function autoFillMonth() {
      openCreateOptionModal();
  }

  function toggleLeaveFromTable(index, isChecked) {
      const item = otHistory[index];
      if(isChecked) {
          item.isLeave = true; item.leaveType = '‡∏•‡∏≤'; item.ot15 = 0; item.ot1 = 0; item.ot3 = 0; item.start = '-'; item.end = '-';
      } else {
          item.isLeave = false; item.isPending = true; item.leaveType = undefined; item.start = '07:30'; item.end = '17:00';
      }
      try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e){}
      renderHistory();
  }

  function toggleType(index) {
      const item = otHistory[index];
      const newType = item.type === 'weekday' ? 'weekend' : 'weekday';
      item.type = newType;
      if (!item.isPending && !item.isLeave) { 
           const result = calculateCore(item.start, item.end, item.date, newType);
           if(result) {
               item.ot15 = result.ot15; item.ot1 = result.ot1; item.ot3 = result.ot3; item.html = result.html; item.timeRange = result.timeRange; item.maxOTMinutes = result.maxOTMinutes;
           }
      }
      try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e){}
      renderHistory(); 
  }

  function editOTHours(index, rateKey) {
      const item = otHistory[index];
      const limitCalc = calculateCore(item.start, item.end, item.date, item.type);
      let currentVal = 0, maxLimit = 0, label = "";
      
      if(rateKey === '15') { currentVal = item.ot15/60; maxLimit = limitCalc.ot15; label = "OT x1.5"; }
      if(rateKey === '1')  { currentVal = item.ot1/60; maxLimit = limitCalc.ot1; label = "OT x1"; }
      if(rateKey === '3')  { currentVal = item.ot3/60; maxLimit = limitCalc.ot3; label = "OT x3"; }
      
      const newValStr = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${label} (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${(maxLimit/60).toFixed(2)})`, currentVal.toFixed(1));
      if(newValStr !== null) {
          const newVal = parseFloat(newValStr);
          if(isNaN(newVal) || newVal < 0) { alert('‚ùå ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
          const newValMinutes = Math.round(newVal * 60);
          if(newValMinutes > maxLimit + 1) { alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á (${(maxLimit/60).toFixed(2)})`); return; }

          let proposedTotal = 0;
          if(rateKey === '15') proposedTotal = newValMinutes; 
          else {
              let ot1 = (rateKey === '1') ? newValMinutes : (item.ot1||0);
              let ot3 = (rateKey === '3') ? newValMinutes : (item.ot3||0);
              proposedTotal = ot1 + ot3;
              const maxTotal = (limitCalc.ot1 || 0) + (limitCalc.ot3 || 0);
              if(proposedTotal > maxTotal + 1) { alert(`‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô (${(maxTotal/60).toFixed(2)})`); return; }
          }
          
          if(rateKey === '15') item.ot15 = newValMinutes;
          if(rateKey === '1')  item.ot1 = newValMinutes;
          if(rateKey === '3')  item.ot3 = newValMinutes;
          
          try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); } catch(e){}
          renderHistory();
      }
  }

  function viewDetail(index) {
      const item = otHistory[index];
      if(!item) return;
      document.getElementById('modalBody').innerHTML = item.html;
      document.getElementById('detailModal').classList.add('show');
  }

  function closeModal() { document.getElementById('detailModal').classList.remove('show'); }
  
  function deleteHistory(index) {
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) return;
    otHistory.splice(index, 1);
    try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); updateBadge(); renderHistory(); } catch(e) {}
  }

  function resetOT() {
    const s = document.getElementById('startTime');
    const e = document.getElementById('endTime');
    if(s) s.value = '07:30';
    if(e) e.value = '17:00';
    
    const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
      
    const dateInput = document.getElementById('workDate');
    if(dateInput) {
        dateInput.value = `${year}-${month}-${day}`;
        syncDateDisplay('workDate', 'workDateShow');
    }
      
    updateThaiDateDisplay();
      
    const dayOfWeek = now.getDay();
    const typeVal = (dayOfWeek===0||dayOfWeek===6)?'weekend':'weekday';
    const rad = document.querySelector(`input[name="type"][value="${typeVal}"]`);
    if(rad) { rad.checked=true; updateRadioStyle(); }

    const res = document.getElementById('result');
    if(res) res.innerHTML = '';
    const saveSec = document.getElementById('saveSection');
    if(saveSec) saveSec.style.display = 'none';
    editingRowIndex = null; 
  }

  function renderHistory() {
    let targetMonth = null;
    let targetYear = null;
      
    if (!showAll) {
        // üü¢ FIX: Use independent history picker
        const historyPickerVal = document.getElementById('historyMonthPicker').value;
        if (historyPickerVal) {
            const [y, m] = historyPickerVal.split('-');
            targetMonth = parseInt(m) - 1;
            targetYear = parseInt(y);
        } else {
            // Default to current date or workDate if picker is empty on first load
            const defaultDate = new Date(); // Or read from workDate if preferred default
            targetMonth = defaultDate.getMonth();
            targetYear = defaultDate.getFullYear();
            
            // Set the picker value to reflect this default
            const mStr = String(targetMonth + 1).padStart(2, '0');
            document.getElementById('historyMonthPicker').value = `${targetYear}-${mStr}`;
        }
    }

    const driverFilterVal = document.getElementById('historyDriverFilter').value;
    const monthsTh = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      
    if (showAll) {
        document.getElementById('historyDateDisplay').textContent = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)";
        document.getElementById('historyMonthPicker').value = "";
    } else if (targetMonth !== null) {
        // üü¢ Thai Year Full
        const thaiYear = targetYear + 543; 
        document.getElementById('historyDateDisplay').textContent = `${monthsTh[targetMonth]} ${thaiYear}`;
        
        // Sync hidden input
        const monthStr = String(targetMonth + 1).padStart(2, '0');
        document.getElementById('historyMonthPicker').value = `${targetYear}-${monthStr}`; 
    }

    const tbody = document.getElementById('historyList');
    tbody.innerHTML = '';
    let s15=0, s1=0, s3=0;
    let leaveCount = 0; 
    filteredIndices = []; 

    // === BRANCH LOGIC: Daily vs Driver ===
    if(currentHistoryMode === 'driver') {
        // --- üü¢ DRIVER SUMMARY MODE ---
        // Change Table Headers
        document.querySelector('#historyTable thead').innerHTML = `
            <tr>
                <th width="5%" class="col-center">#</th>
                <th width="20%">‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£.</th>
                <th width="12%" class="col-center" style="background:#eff6ff; color:#1e3a8a;">x1.5 (‡∏ä‡∏°.)</th>
                <th width="12%" class="col-center" style="background:#ecfeff; color:#0e7490;">x1 (‡∏ä‡∏°.)</th>
                <th width="12%" class="col-center" style="background:#fff1f2; color:#be123c;">x3 (‡∏ä‡∏°.)</th>
                <th width="12%" class="col-center">‡∏£‡∏ß‡∏° (‡∏ä‡∏°.)</th>
                <th width="10%" class="col-center">‡∏ß‡∏±‡∏ô‡∏•‡∏≤</th>
                <th width="17%">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏î</th>
            </tr>
        `;

        // Process Data
        const summaryMap = {};

        // üü¢ Step 1: Pre-fill with ALL registered drivers (so they appear even with 0 data)
        drivers.forEach(d => {
            summaryMap[d.name] = { ot15:0, ot1:0, ot3:0, leave:0, missingCount:0, hasData: false }; 
        });
        
        otHistory.forEach((item) => {
            // Filter Logic
            let isMatch = true;
            if (!showAll && targetMonth !== null) {
                const d = new Date(item.date);
                if (d.getMonth() !== targetMonth || d.getFullYear() !== targetYear) isMatch = false;
            }
            // Note: If driver filter is on, we only show that driver, otherwise all.

            if(isMatch) {
                const driverKey = item.driver || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)";
                if(!summaryMap[driverKey]) {
                    summaryMap[driverKey] = { ot15:0, ot1:0, ot3:0, leave:0, missingCount:0 };
                }
                
                if(item.isLeave) {
                    summaryMap[driverKey].leave++;
                } else if(!item.isPending) {
                    summaryMap[driverKey].ot15 += (item.ot15 || 0);
                    summaryMap[driverKey].ot1 += (item.ot1 || 0);
                    summaryMap[driverKey].ot3 += (item.ot3 || 0);
                }

                if(item.isIncomplete) {
                    summaryMap[driverKey].missingCount++;
                }
            }
        });

        // üü¢ FIX: Sort by original driver list order (index)
        let driverNames = Object.keys(summaryMap);
        
        // Custom Sort: Match order in 'drivers' array
        driverNames.sort((a, b) => {
            const indexA = drivers.findIndex(d => d.name === a);
            const indexB = drivers.findIndex(d => d.name === b);
            // If not found in list (e.g. deleted driver but has history), put at end
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });
        
        // Apply Driver Filter if selected
        if (driverFilterVal !== "") {
            driverNames = driverNames.filter(name => name === driverFilterVal);
        }

        if(driverNames.length === 0) {
            document.getElementById('emptyMsg').style.display = 'block';
        } else {
            document.getElementById('emptyMsg').style.display = 'none';
            driverNames.forEach((name, idx) => {
                const data = summaryMap[name];
                const totalMins = data.ot15 + data.ot1 + data.ot3;
                
                // Sum Global Stats for Dashboard (Top Cards)
                s15 += data.ot15;
                s1 += data.ot1;
                s3 += data.ot3;
                leaveCount += data.leave;

                let missingHtml = '-';
                if(data.missingCount > 0) {
                    // üü¢ Update: Clickable Missing Alert
                    missingHtml = `<span style="background:#fef2f2; color:#ef4444; padding:4px 10px; border-radius:99px; font-weight:700; font-size:0.8rem; border:1px solid #fca5a5; cursor:pointer; transition:transform 0.2s;" onclick="viewDriverMissing('${name}')" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î ${data.missingCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏î‡∏π)</span>`;
                }

                // Find original index for display #
                const realIndex = drivers.findIndex(d => d.name === name) + 1;
                const displayIndex = realIndex > 0 ? realIndex : '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-center">${displayIndex}</td>
                    <td style="font-weight:700; color:var(--brand);">${name}</td>
                    <td class="col-center">${fmtShort(data.ot15)}</td>
                    <td class="col-center">${fmtShort(data.ot1)}</td>
                    <td class="col-center">${fmtShort(data.ot3)}</td>
                    <td class="col-center" style="font-weight:800;">${fmtShort(totalMins)}</td>
                    <td class="col-center" style="color:#ef4444; font-weight:700;">${data.leave}</td>
                    <td style="font-size:0.85rem; text-align:center;">${missingHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

    } else {
        // --- üîµ DAILY MODE (Original) ---
        // Restore Headers
        document.querySelector('#historyTable thead').innerHTML = `
            <tr>
                <th width="5%" class="col-center">‡∏•‡∏≤</th>
                <th width="12%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th width="10%" class="col-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th width="20%" class="col-center">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th width="10%" class="col-center" style="background:#eff6ff; color:#1e3a8a; border-bottom-color:#bfdbfe;">x1.5</th>
                <th width="10%" class="col-center" style="background:#ecfeff; color:#0e7490; border-bottom-color:#a5f3fc;">x1</th>
                <th width="10%" class="col-center" style="background:#fff1f2; color:#be123c; border-bottom-color:#fecdd3;">x3</th>
                <th width="10%" class="col-center">‡∏£‡∏ß‡∏°</th>
                <th width="18%" class="col-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
            </tr>
        `;

        otHistory.forEach((item, index) => {
            let isMatch = true;
            if (!showAll) {
                 if (targetMonth !== null) {
                    const itemDate = new Date(item.date);
                    if (itemDate.getMonth() !== targetMonth || itemDate.getFullYear() !== targetYear) {
                        isMatch = false;
                    }
                 }
            }
            if (driverFilterVal !== "") {
                const dName = item.driver || "";
                if(dName !== driverFilterVal) {
                    isMatch = false;
                }
            }

            if (isMatch) {
                filteredIndices.push(index); 
            }
        });

        if(filteredIndices.length === 0) {
            document.getElementById('emptyMsg').style.display = 'block';
        } else {
            document.getElementById('emptyMsg').style.display = 'none';
            
            filteredIndices.forEach((originalIndex, i) => {
                const item = otHistory[originalIndex];
                
                if(item.isLeave) { leaveCount++; }

                if(!item.isPending && !item.isLeave) {
                    s15 += item.ot15 || 0; 
                    s1 += item.ot1 || 0; 
                    s3 += item.ot3 || 0;
                }
                
                const tr = document.createElement('tr');
                let totalText = '-';
                if(!item.isPending && !item.isLeave) {
                     const totalMinutes = (item.ot15||0) + (item.ot1||0) + (item.ot3||0);
                     totalText = fmt(totalMinutes);
                }

                let driverHtml = item.driver ? `<div style="font-size:0.8rem; color:var(--brand); font-weight:700; margin-bottom:2px; opacity:0.8;">üë§ ${item.driver}</div>` : '';
                const isChecked = item.isLeave ? 'checked' : '';
                const checkboxHtml = `<input type="checkbox" ${isChecked} onchange="toggleLeaveFromTable(${originalIndex}, this.checked)" style="width:18px; height:18px; cursor:pointer;">`;

                if(item.isLeave) {
                    const leavePill = `<span class="pill" style="background:#fef2f2; color:#ef4444; border:1px solid #fecaca; cursor:default;">‡∏•‡∏≤</span>`;
                    let dateContent = `${driverHtml}${formatThaiDate(item.date)}`;
                    let leaveTypeContent = ''; 
                    if(item.isIncomplete) {
                          leaveTypeContent = `<div style="background:#f3e8ff; border:1px dashed #d8b4fe; border-radius:6px; padding:2px 8px; color:#7e22ce; font-size:0.8rem; text-align:left; white-space: normal;">üìù ${item.incompleteReason || '‡∏Ç‡∏≤‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'}</div>`;
                    } else {
                        leaveTypeContent = '-'; 
                    }

                    tr.innerHTML = `
                        <td class="col-center">${checkboxHtml}</td>
                        <td style="font-weight:600; color:#ef4444; opacity:0.8;">${dateContent}</td>
                        <td class="col-center">${leavePill}</td>
                        <td class="col-center" style="font-weight:bold; color:#ef4444; vertical-align:middle;">${leaveTypeContent}</td>
                        <td class="col-center" style="background:#f9fafb; opacity:0.5;">-</td>
                        <td class="col-center" style="background:#f9fafb; opacity:0.5;">-</td>
                        <td class="col-center" style="background:#f9fafb; opacity:0.5;">-</td>
                        <td class="col-center">-</td>
                        <td class="col-center">
                            ${item.isIncomplete ? `<button class="action-btn view-btn" onclick="resolveIncomplete(${originalIndex})" title="‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" style="color:#10b981; background:#ecfdf5; margin-right:4px;">‚úÖ</button>` : ''}
                            <button class="action-btn del-btn" onclick="deleteHistory(${originalIndex})" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </td>
                    `;
                } else {
                    const pillClass = item.type === 'weekday' ? 'pill-weekday' : 'pill-weekend';
                    const pillText = item.type === 'weekday' ? '‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤' : '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
                    const pillHtml = `<span class="pill ${pillClass}" onclick="toggleType(${originalIndex})" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô (‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤/‡∏´‡∏¢‡∏∏‡∏î)">${pillText}</span>`;

                    let timeContent = '';
                    let otHtml = '';
                    let actionBtnHtml = '';
                    let dateContent = `${driverHtml}${formatThaiDate(item.date)}`;
                    
                    if(item.isPending) {
                         timeContent = `<span class="time-range pending" onclick="editInline(${originalIndex})" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</span>`;
                    } else {
                         timeContent = `<span class="time-range" onclick="editInline(${originalIndex})" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤">${item.timeRange}</span>`;
                    }
                    
                    if(item.isIncomplete) {
                        timeContent += `<div style="background:#f3e8ff; border:1px dashed #d8b4fe; border-radius:6px; padding:2px 8px; color:#7e22ce; font-size:0.8rem; text-align:left; margin-top:4px; white-space: normal;">üìù ${item.incompleteReason || '‡∏Ç‡∏≤‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'}</div>`;
                    }

                    if(item.isPending) {
                        otHtml = `<td class="col-center" style="color:#cbd5e1">-</td><td class="col-center" style="color:#cbd5e1">-</td><td class="col-center" style="color:#cbd5e1">-</td>`;
                        actionBtnHtml = `<button class="action-btn del-btn" onclick="deleteHistory(${originalIndex})" title="‡∏•‡∏ö">üóëÔ∏è</button>`;
                    } else {
                        otHtml = `<td class="col-center"><span class="ot-val val-15" onclick="editOTHours(${originalIndex}, '15')">${fmtShort(item.ot15)}</span></td><td class="col-center"><span class="ot-val val-1" onclick="editOTHours(${originalIndex}, '1')">${fmtShort(item.ot1)}</span></td><td class="col-center"><span class="ot-val val-3" onclick="editOTHours(${originalIndex}, '3')">${fmtShort(item.ot3)}</span></td>`;
                        actionBtnHtml = `<button class="action-btn view-btn" onclick="viewDetail(${originalIndex})" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">üîç</button><button class="action-btn reset-btn" onclick="resetHistoryItem(${originalIndex})" title="‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á">üßπ</button>`;
                    }
                    
                    if(item.isIncomplete) {
                         actionBtnHtml = `<button class="action-btn view-btn" onclick="resolveIncomplete(${originalIndex})" title="‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" style="color:#10b981; background:#ecfdf5; margin-right:4px;">‚úÖ</button>` + actionBtnHtml;
                    }

                    if(editingRowIndex === originalIndex) {
                        tr.innerHTML = `
                            <td class="col-center">${checkboxHtml}</td>
                            <td><input type="date" id="editDate" value="${item.date}" class="mini-input" style="width:100%; min-width:120px;" lang="th-TH"></td>
                            <td class="col-center">${pillHtml}</td>
                            <td class="col-center" colspan="3">
                                <div class="edit-row-wrap">
                                    <input type="tel" id="editStart" value="${item.start || '07:30'}" class="mini-input"><span>-</span><input type="tel" id="editEnd" value="${item.end || '17:00'}" class="mini-input">
                                    <button onclick="saveInline(${originalIndex})" class="mini-btn ok">‚úî</button>
                                    <button onclick="cancelInline()" class="mini-btn cancel">‚úñ</button>
                                </div>
                            </td>
                            <td class="col-center"><span style="color:#94a3b8; font-size:0.8rem;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...</span></td>
                        `;
                         setTimeout(() => {
                            const inputs = ['editStart', 'editEnd'];
                            inputs.forEach(id => {
                                const el = document.getElementById(id);
                                if(el) {
                                    el.addEventListener('input', formatTimeInput);
                                    el.addEventListener('blur', validateTimeInput);
                                    el.addEventListener('focus', function() { this.select(); });
                                    el.addEventListener('click', function() { this.select(); });
                                    el.addEventListener('keydown', function(e) { if(e.key === 'Enter') { saveInline(originalIndex); } });
                                }
                            });
                            const s = document.getElementById('editStart');
                            const e = document.getElementById('editEnd');
                            if(s && e) {
                                s.addEventListener('input', function() { if(this.value.length === 5) { e.focus(); e.select(); } });
                            }
                            if(s) { s.focus(); s.select(); }
                        }, 50);
                    } else {
                        tr.innerHTML = `
                            <td class="col-center">${checkboxHtml}</td>
                            <td style="font-weight:600; ${item.isPending ? 'color:#64748b' : ''}">${dateContent}</td>
                            <td class="col-center">${pillHtml}</td>
                            <td class="col-center" style="vertical-align:top; padding-top:12px;">${timeContent}</td>
                            ${otHtml}
                            <td class="col-center" style="font-weight:800; color:var(--brand); font-size:1rem;">${totalText}</td>
                            <td class="col-center">${actionBtnHtml}</td>
                        `;
                    }
                }
                tbody.appendChild(tr);
            });
        }
    }

    // Common Footer Update (Same logic for both views)
    document.getElementById('sum15').innerText = (s15/60).toFixed(1); 
    document.getElementById('sum1').innerText = (s1/60).toFixed(1);
    document.getElementById('sum3').innerText = (s3/60).toFixed(1);
    let totalAllMinutes = s15 + s1 + s3;
    document.getElementById('sumLeaveDays').innerText = leaveCount;
    document.getElementById('sumTotal_b').innerText = (totalAllMinutes/60).toFixed(1); 
  }

  /* ===== üü¢ DOMContentLoaded MAIN ===== */
  document.addEventListener('DOMContentLoaded', () => {
        // Init Helpers
        window.resetOT();
        renderDrivers();
        renderHistory(); // Ensure history loads initially

        // üü¢ FIX: Dropdown Menu Logic (Moved to JS for reliability)
        const historyBtn = document.getElementById('historyTitleBtn');
        const summaryMenu = document.getElementById('summaryMenu');
        
        if(historyBtn && summaryMenu) {
            // Toggle Menu
            historyBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop bubbling to window
                summaryMenu.classList.toggle('show');
            });

            // Close when clicking outside
            window.addEventListener('click', () => {
                if (summaryMenu.classList.contains('show')) {
                    summaryMenu.classList.remove('show');
                }
            });

            // Handle Options
            summaryMenu.querySelectorAll('.menu-opt').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const mode = opt.getAttribute('data-mode');
                    setHistoryMode(mode);
                    summaryMenu.classList.remove('show');
                });
            });
        }

        // üü¢ History Month Picker Listener
        const historyPicker = document.getElementById('historyMonthPicker');
        if(historyPicker) {
            historyPicker.addEventListener('change', (e) => {
                const val = e.target.value; // YYYY-MM
                if(val) {
                    const [y, m] = val.split('-');
                    // üü¢ FIX: NO SYNC back to main page (Independent)
                    
                    updateThaiDateDisplay();
                    showAll = false; 
                    renderHistory();
                }
            });
        }

        // 1. Sidebar Toggle
        const btnToggle = document.getElementById('btnToggle');
        if(btnToggle) {
            btnToggle.addEventListener('click', ()=>{
                sidebar.classList.toggle('collapsed');
                try { localStorage.setItem('egat_sidebar_collapsed', sidebar.classList.contains('collapsed')?'1':'0'); } catch(e){}
            });
        }

        // 2. Work Date Listeners
        const workDateInput = document.getElementById('workDate');
        if(workDateInput) {
            workDateInput.addEventListener('change', () => {
                updateThaiDateDisplay();
                // üü¢ FIX: Don't auto-refresh history to match this date anymore
                // showAll = false; 
                // renderHistory();
            });
            workDateInput.addEventListener('input', updateThaiDateDisplay);
        }

        // 3. Save Button
        const btnSaveLog = document.getElementById('btnSaveLog');
        if(btnSaveLog) {
            btnSaveLog.addEventListener('click', () => {
                if(!currentCalcResult) return;
                const existingIndex = otHistory.findIndex(item => 
                    item.date === currentCalcResult.date && ((item.driver || "") === (currentCalcResult.driver || "") || !item.driver)
                );
                if(existingIndex !== -1) { currentCalcResult.id = otHistory[existingIndex].id; otHistory[existingIndex] = currentCalcResult; } 
                else { otHistory.push(currentCalcResult); }
                sortHistory(); 
                try { localStorage.setItem('egat_ot_history', JSON.stringify(otHistory)); const btn = document.getElementById('btnSaveLog'); btn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'; btn.disabled = true; btn.style.background = '#64748b'; updateBadge(); renderHistory(); } catch(e) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Storage ‡πÄ‡∏ï‡πá‡∏°)'); }
            });
        }
        
        // 4. Calc Button
        const btnCalc = document.getElementById('btnCalc');
        if(btnCalc) { btnCalc.addEventListener('click', calculateOT); }

        // 5. Radio Buttons
        document.querySelectorAll('input[name="type"]').forEach(r => {
            r.addEventListener('change', updateRadioStyle);
        });

        // 6. Time Inputs (Main Form)
        document.querySelectorAll('.time-manual').forEach(inp => {
            inp.addEventListener('input', formatTimeInput);
            inp.addEventListener('blur', validateTimeInput);
            inp.addEventListener('focus', function() { this.select(); }); 
        });

        // 7. Auto-focus Logic (Main Form)
        const mainStart = document.getElementById('startTime');
        const mainEnd = document.getElementById('endTime');
        if(mainStart && mainEnd) {
            mainStart.addEventListener('input', function() {
                if(this.value.length === 5) {
                    mainEnd.focus();
                    mainEnd.select(); 
                }
            });
        }

        // üü¢ 8. Global Key Listener for Up/Down Navigation in Edit Mode
        window.addEventListener('keydown', (e) => {
            if(editingRowIndex !== null) {
                if(e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveInline(-1);
                } else if(e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveInline(1);
                }
            }
            // üü¢ ESC to close all modals
            if(e.key === 'Escape') {
                closeModal();
                // closeLeaveModal(); // Function must exist if used
                closeDeleteModal();
                closeIncompleteModal();
                closeAddDriverModal();
                closeSummaryModal();
                closeCreateOptionModal();
                closeCustomMonthPicker();
            }
        });
  });
  
  /* ===== Service Worker Kill Switch ===== */
  if ('serviceWorker' in navigator) { try { navigator.serviceWorker.getRegistrations().then(function(registrations) { for(let registration of registrations) { registration.unregister(); } }).catch(function(err) {}); } catch(e) {} }
</script>
</body>
</html>